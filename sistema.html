<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cl√≠nicaSys Pro v6.0 - TV Integrada</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <style>
      :root {
        --bg-main: #111827;
        --bg-card: #1f2937;
        --bg-input: #374151;
        --text: #f3f4f6;
        --muted: #9ca3af;
        --primary: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
        --info: #3b82f6;
        --border: #4b5563;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Inter", sans-serif;
      }
      body {
        background: var(--bg-main);
        color: var(--text);
        height: 100vh;
        overflow: hidden;
      }
      .dash-top-row {
        display: grid;
        grid-template-columns: 1fr 1fr; /* 50% para cada */
        gap: 1.5rem;
        margin-bottom: 1.5rem;
      }
      @media (max-width: 1000px) {
        .dash-top-row {
          grid-template-columns: 1fr;
        }
      }

      /* Ajuste de altura do Calend√°rio e Gr√°fico */
      .dash-widget {
        height: 400px; /* Altura fixa menor */
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      /* Estilo da Nova Grid Completa */
      .dash-grid-toolbar {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        background: var(--bg-input);
        padding: 10px;
        border-radius: 8px;
        flex-wrap: wrap;
        align-items: center;
      }
      .dash-grid-title {
        font-size: 1.2rem;
        font-weight: bold;
        color: var(--primary);
        margin-right: auto;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .status-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: bold;
        text-transform: uppercase;
      }
      .st-agendado {
        background: #f59e0b;
        color: black;
      }
      .st-confirmado {
        background: #3b82f6;
        color: white;
      }
      .st-atendimento {
        background: #ec4899;
        color: white;
      }
      .st-finalizado {
        background: #10b981;
        color: white;
      }
      .st-cancelado {
        background: #ef4444;
        color: white;
      }

      /* Bot√µes de A√ß√£o na Grid */
      .grid-actions {
        display: flex;
        gap: 5px;
        justify-content: flex-end;
      }

      #login-screen {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        width: 100%;
        position: fixed;
        top: 0;
        left: 0;
        background: var(--bg-main);
        z-index: 99999;
      }
      .login-box {
        background: var(--bg-card);
        padding: 3rem;
        border-radius: 12px;
        border: 1px solid var(--border);
        width: 400px;
        text-align: center;
      }
      .login-box h2 {
        color: var(--primary);
        margin-bottom: 2rem;
      }
      .login-box input {
        width: 100%;
        padding: 12px;
        margin-bottom: 1rem;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: white;
      }
      .login-box button {
        width: 100%;
        padding: 12px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        transition: 0.3s;
      }
      .evento-contador {
        text-align: center !important;
        justify-content: center !important;
        font-weight: bold !important;
        font-size: 0.85rem !important;
        border-radius: 4px !important;
        cursor: pointer !important;
        margin-top: 2px !important;
        border: none !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }
      .evento-contador:hover {
        filter: brightness(1.1);
        transform: scale(1.02);
      }

      #app-screen {
        display: none;
        height: 100vh;
        width: 100%;
        position: relative;
        z-index: 1;
        display: flex;
      }

      aside {
        width: 260px;
        background: var(--bg-card);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        padding: 1.5rem 1.5rem 150px 1.5rem;
        transition: width 0.3s;
        flex-shrink: 0;
        overflow-y: auto;
      }
      @media (max-width: 800px) {
        aside {
          width: 70px;
          padding: 1rem 0.5rem 150px 0.5rem;
        }
        aside h2,
        aside small,
        aside button span {
          display: none;
        }
        aside button {
          justify-content: center;
        }
      }

      main {
        flex: 1;
        overflow-y: auto;
        padding: 2rem;
        min-width: 0;
      }

      .btn {
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        color: white;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        transition: 0.2s;
        font-size: 0.9rem;
      }
      .btn:hover {
        opacity: 0.9;
        transform: translateY(-1px);
      }
      .btn-p {
        background: var(--primary);
      }
      .btn-d {
        background: var(--danger);
      }
      .btn-s {
        background: var(--bg-input);
      }
      .btn-i {
        background: var(--info);
      }

      /* === NOVO: BOT√ÉO DE CHAMAR NA TV === */
      .btn-chamar {
        width: 100%;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        padding: 12px;
        font-size: 1.1rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-top: 10px;
        margin-bottom: 10px;
        box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
        border: none;
        border-radius: 6px;
        color: white;
        font-weight: 800;
        cursor: pointer;
        transition: all 0.2s;
      }
      .btn-chamar:hover {
        transform: scale(1.02);
        box-shadow: 0 6px 15px rgba(16, 185, 129, 0.5);
      }
      .btn-chamar:active {
        transform: scale(0.98);
      }

      .card {
        background: var(--bg-card);
        padding: 1.5rem;
        border-radius: 12px;
        border: 1px solid var(--border);
        margin-bottom: 1.5rem;
        overflow: auto;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
      }

      .dash-content {
        display: grid;
        grid-template-columns: 3fr 1fr;
        gap: 1.5rem;
      }
      @media (max-width: 1200px) {
        .dash-content {
          grid-template-columns: 2fr 1fr;
        }
      }
      @media (max-width: 1000px) {
        .dash-content {
          grid-template-columns: 1fr;
        }
      }

      /* === SALA DE ESPERA === */
      .espera-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
      }
      .espera-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 1.5rem;
        position: relative;
        border-left: 6px solid var(--muted);
        display: flex;
        flex-direction: column;
        gap: 5px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        transition: transform 0.2s;
      }
      .espera-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3);
      }
      .ec-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
      }
      .ec-time {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text);
        letter-spacing: -1px;
        line-height: 1;
      }
      .ec-status-badge {
        font-size: 0.7rem;
        padding: 3px 8px;
        border-radius: 4px;
        background: var(--bg-input);
        color: white;
        font-weight: 600;
        text-transform: uppercase;
      }

      /* TEMPO DE ESPERA VISUAL */
      .tempo-espera {
        font-size: 0.85rem;
        font-weight: 700;
        padding: 6px 12px;
        border-radius: 6px;
        display: inline-block;
        margin-top: 8px;
        animation: pulse 2s ease-in-out infinite;
      }
      .tempo-ok {
        background: #10b981;
        color: white;
      }
      .tempo-alerta {
        background: #f59e0b;
        color: white;
      }
      .tempo-critico {
        background: #ef4444;
        color: white;
        animation: pulse 1s ease-in-out infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      .ec-body h3 {
        font-size: 1.2rem;
        color: white;
        margin-bottom: 8px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: 600;
      }
      .ec-prof {
        font-size: 0.9rem;
        color: var(--muted);
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 4px;
      }
      .ec-room {
        font-size: 0.85rem;
        color: var(--primary);
        font-weight: 600;
      }

      /* BORDAS DE STATUS */
      .border-agendado {
        border-left-color: var(--muted);
      }
      .border-confirmado {
        border-left-color: var(--info);
      }
      .border-espera {
        border-left-color: var(--warning);
      }
      .border-atendimento {
        border-left-color: #ec4899;
        box-shadow: 0 0 15px rgba(236, 72, 153, 0.3);
      }
      .border-finalizado {
        border-left-color: var(--primary);
      }
      .border-cancelado {
        border-left-color: var(--danger);
        opacity: 0.6;
      }

      /* TIMELINE */
      .timeline-container {
        margin-top: 1.5rem;
      }
      .timeline-header {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        align-items: center;
      }
      .timeline-grid {
        display: grid;
        grid-template-columns: 80px 1fr;
        gap: 0;
        border: 1px solid var(--border);
        border-radius: 8px;
        overflow: hidden;
      }
      .timeline-hour {
        background: var(--bg-input);
        padding: 15px 10px;
        text-align: center;
        font-weight: 600;
        border-bottom: 1px solid var(--border);
        font-size: 0.9rem;
      }
      .timeline-slot {
        background: var(--bg-card);
        padding: 10px;
        border-bottom: 1px solid var(--border);
        min-height: 60px;
        position: relative;
      }
      .timeline-event {
        background: linear-gradient(135deg, var(--primary) 0%, #059669 100%);
        padding: 8px 12px;
        border-radius: 6px;
        margin-bottom: 5px;
        cursor: pointer;
        transition: all 0.2s;
        border-left: 4px solid #047857;
      }
      .timeline-event:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
      }
      .timeline-event-name {
        font-weight: 600;
        font-size: 0.9rem;
      }
      .timeline-event-prof {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.8);
        margin-top: 2px;
      }
      .timeline-empty {
        color: var(--muted);
        font-size: 0.85rem;
        font-style: italic;
      }

      /* BUSCA */
      .search-wrapper {
        position: relative;
        width: 100%;
        max-width: 400px;
      }
      .search-input {
        width: 100%;
        padding: 12px 40px 12px 16px;
        background: var(--bg-input);
        border: 2px solid var(--border);
        border-radius: 8px;
        color: white;
        font-size: 0.95rem;
        transition: all 0.3s;
      }
      .search-input:focus {
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
      }
      .search-icon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--muted);
      }
      .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 8px;
        margin-top: 5px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      }
      .search-result-item {
        padding: 12px 16px;
        cursor: pointer;
        border-bottom: 1px solid var(--border);
        transition: background 0.2s;
      }
      .search-result-item:hover {
        background: var(--bg-input);
      }
      .search-result-item:last-child {
        border-bottom: none;
      }
      .search-highlight {
        background: var(--primary);
        color: white;
        padding: 2px 4px;
        border-radius: 3px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
      }
      th {
        padding: 12px;
        background: var(--bg-input);
        color: var(--muted);
        text-align: left;
        font-size: 0.85rem;
      }
      td {
        padding: 12px;
        border-bottom: 1px solid var(--border);
        font-size: 0.9rem;
      }
      input,
      select,
      textarea {
        background: var(--bg-input);
        border: 1px solid var(--border);
        padding: 10px;
        border-radius: 6px;
        color: white;
        width: 100%;
        outline: none;
        margin-bottom: 10px;
      }
      label {
        display: block;
        color: var(--muted);
        font-size: 0.8rem;
        margin-bottom: 4px;
      }

      nav button {
        width: 100%;
        padding: 12px;
        background: transparent;
        border: none;
        color: var(--muted);
        text-align: left;
        cursor: pointer;
        border-radius: 8px;
        margin-bottom: 5px;
        font-weight: 500;
        display: flex;
        gap: 10px;
      }
      nav button:hover,
      nav button.active {
        background: var(--primary);
        color: white;
      }

      .tabs {
        display: flex;
        border-bottom: 1px solid var(--border);
        margin-bottom: 1.5rem;
      }
      .tab {
        padding: 10px 20px;
        cursor: pointer;
        color: var(--muted);
        border-bottom: 2px solid transparent;
      }
      .tab.active {
        color: var(--primary);
        border-color: var(--primary);
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }

      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        justify-content: center;
        align-items: flex-start;
        z-index: 100;
        overflow-y: auto;
        padding: 2rem;
        backdrop-filter: blur(3px);
      }
      .modal {
        background: var(--bg-card);
        width: 100%;
        max-width: 700px;
        padding: 2rem;
        border-radius: 12px;
        border: 1px solid var(--border);
        position: relative;
      }
      .modal-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }
      .row {
        display: flex;
        gap: 10px;
      }
      .col {
        flex: 1;
      }

      #toast {
        visibility: hidden;
        min-width: 250px;
        background-color: #10b981;
        color: #fff;
        text-align: center;
        border-radius: 4px;
        padding: 16px;
        position: fixed;
        z-index: 2000;
        left: 50%;
        bottom: 30px;
        transform: translateX(-50%);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        font-weight: bold;
      }
      #toast.show {
        visibility: visible;
        animation: fadein 0.5s, fadeout 0.5s 2.5s;
      }
      @keyframes fadein {
        from {
          bottom: 0;
          opacity: 0;
        }
        to {
          bottom: 30px;
          opacity: 1;
        }
      }
      @keyframes fadeout {
        from {
          bottom: 30px;
          opacity: 1;
        }
        to {
          bottom: 0;
          opacity: 0;
        }
      }

      .wa-icon {
        width: 24px;
        height: 24px;
        fill: #25d366;
        vertical-align: middle;
        cursor: pointer;
        transition: transform 0.2s;
      }
      .wa-icon:hover {
        transform: scale(1.2);
      }

      .rel-summary {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      .rel-card {
        flex: 1;
        background: var(--bg-input);
        padding: 15px;
        border-radius: 8px;
        text-align: center;
      }
      .rel-card h3 {
        font-size: 0.9rem;
        color: var(--muted);
      }
      .rel-card h1 {
        font-size: 1.5rem;
        color: white;
      }

      #print-receita {
        display: none;
      }
      @media print {
        body * {
          visibility: hidden;
        }
        #print-receita,
        #print-receita * {
          visibility: visible;
          display: block;
        }
        #print-receita {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          background: white;
          color: black;
          padding: 2rem;
          font-size: 12pt;
        }
        #v-relatorios {
          display: block !important;
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: auto;
          background: white;
          color: black;
          padding: 20px;
          z-index: 9999;
        }
        #v-relatorios * {
          visibility: visible;
          color: black !important;
          background: transparent !important;
          box-shadow: none !important;
          border-color: #ccc !important;
        }
        #rel-tab {
          border: 1px solid #000;
          width: 100%;
          border-collapse: collapse;
        }
        #rel-tab th,
        #rel-tab td {
          border: 1px solid #000;
          padding: 8px;
          text-align: left;
          font-size: 10pt;
        }
        .no-print,
        button,
        input,
        select,
        label,
        .fc-header-toolbar {
          display: none !important;
        }
        .rel-summary {
          display: flex !important;
        }
        body {
          background: white !important;
          height: auto;
          overflow: visible;
        }
      }
    </style>
  </head>
  <body>
    <div id="login-screen">
      <div class="login-box">
        <h2>üè• Cl√≠nicaSys</h2>
        <form onsubmit="event.preventDefault(); doLogin();">
          <input
            type="text"
            id="login-user"
            placeholder="Usu√°rio (admin)"
            required
          />
          <input
            type="password"
            id="login-pass"
            placeholder="Senha (admin123)"
            required
          />
          <button type="submit" id="btn-entrar">Entrar</button>
        </form>
      </div>
    </div>

    <div id="app-screen" style="display: none">
      <aside class="no-print">
        <div style="margin-bottom: 2rem; padding-left: 10px">
          <h2 style="color: var(--primary)">üè• Cl√≠nicaSys</h2>
          <small
            style="
              color: var(--muted);
              font-size: 0.75rem;
              display: block;
              margin-top: 5px;
            "
          >
            Licenciado para:<br /><strong id="header-title" style="color: white"
              >Minha Cl√≠nica</strong
            >
          </small>
        </div>
        <nav>
          <button class="active" onclick="nav('dashboard', this)">
            üìä <span>Dashboard</span>
          </button>
          <button onclick="nav('espera', this)">
            ‚è≥ <span>Sala de Espera</span>
          </button>
          <button onclick="nav('pacientes', this)">
            üë• <span>Pacientes</span>
          </button>
          <button onclick="nav('profissionais', this)">
            üë®‚Äç‚öïÔ∏è <span>Profissionais</span>
          </button>
          <button onclick="nav('agenda', this)">üìÖ <span>Agenda</span></button>
          <button onclick="nav('atendimento', this)">
            ü©∫ <span>Atendimento</span>
          </button>
          <button onclick="nav('financeiro', this)">
            üí∞ <span>Financeiro</span>
          </button>
          <button onclick="nav('relatorios', this)">
            üìà <span>Relat√≥rios</span>
          </button>
          <button onclick="nav('cadastros', this)">
            ‚öôÔ∏è <span>Cadastros</span>
          </button>
        </nav>
        <div
          style="
            margin-top: auto;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
          "
        >
          <button
            class="btn btn-s"
            style="
              width: 100%;
              margin-bottom: 5px;
              background: #059669;
              border: 1px solid #047857;
            "
            onclick="abrirJanelaTV()"
          >
            üñ•Ô∏è <span>Abrir Tela TV</span>
          </button>
          <button
            class="btn btn-s"
            style="width: 100%; margin-bottom: 5px"
            onclick="abrirModalTV()"
          >
            üì° <span>Conectar Smart TV</span>
          </button>
          <button
            class="btn btn-s"
            style="width: 100%; margin-bottom: 5px"
            onclick="abrirModalConta()"
          >
            üë§ <span>Minha Conta</span>
          </button>
          <button
            class="btn btn-s"
            style="width: 100%; margin-bottom: 5px"
            onclick="window.open(API+'/backup')"
          >
            üíæ <span>Backup</span>
          </button>
          <button class="btn btn-d" style="width: 100%" onclick="doLogout()">
            <span>Sair</span>
          </button>
        </div>
      </aside>

      <main id="app">
        <div id="v-dashboard" class="view">
          <div class="grid">
            <div class="card">
              <h3>Hoje</h3>
              <h1 id="d-hoje">0</h1>
            </div>
            <div class="card">
              <h3>M√™s</h3>
              <h1 id="d-mes">0</h1>
            </div>
            <div class="card">
              <h3>Faturamento</h3>
              <h1 style="color: var(--primary)" id="d-fat">R$ 0</h1>
            </div>
            <div class="card">
              <h3>Pend√™ncias</h3>
              <h1 style="color: var(--danger)" id="d-pend">0</h1>
            </div>
          </div>

          <div class="dash-top-row">
            <div class="card dash-widget">
              <div id="calendar" style="font-size: 0.85rem"></div>
            </div>
            <div class="card dash-widget">
              <canvas id="chart"></canvas>
            </div>
          </div>

          <div class="card">
            <div class="dash-grid-toolbar">
              <div class="dash-grid-title">
                üìÖ Agenda de:
                <span id="dash-date-display" style="color: white">Hoje</span>
              </div>

              <select
                id="dash-filter-prof"
                onchange="loadDashGrid(); if(calendar) calendar.refetchEvents()"
                style="width: 180px; margin: 0"
              >
                <option value="">Todos Profissionais</option>
              </select>
              <select
                id="dash-filter-status"
                onchange="loadDashGrid()"
                style="width: 150px; margin: 0"
              >
                <option value="">Todos Status</option>
                <option value="Agendado">Agendado</option>
                <option value="Confirmado">Confirmado</option>
                <option value="Finalizado">Finalizado</option>
              </select>
              <button class="btn btn-p" onclick="modAgDash()">
                + Novo Agendamento
              </button>
            </div>

            <table class="full-grid">
              <thead>
                <tr>
                  <th>Hora</th>
                  <th>Paciente</th>
                  <th>Profissional</th>
                  <th>Status</th>
                  <th>Info</th>
                  <th style="text-align: right">A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="dash-grid-body">
                <tr>
                  <td
                    colspan="6"
                    style="
                      text-align: center;
                      padding: 20px;
                      color: var(--muted);
                    "
                  >
                    Selecione uma data no calend√°rio...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div id="v-espera" class="view" style="display: none">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 1.5rem;
              flex-wrap: wrap;
              gap: 10px;
            "
          >
            <h2>‚è≥ Sala de Espera (Hoje)</h2>
            <div style="display: flex; gap: 10px">
              <button class="btn btn-i" onclick="toggleTimeline()">
                üìä Timeline
              </button>
              <button class="btn btn-p" onclick="loadEspera()">
                üîÑ Atualizar
              </button>
            </div>
          </div>

          <div id="timeline-view" class="card" style="display: none">
            <div class="timeline-header">
              <h3>üìÖ Timeline do Dia</h3>
              <select
                id="timeline-prof-filter"
                onchange="loadTimeline()"
                style="width: 200px; margin-bottom: 0"
              >
                <option value="">Todos Profissionais</option>
              </select>
            </div>
            <div id="timeline-content" class="timeline-grid"></div>
          </div>

          <div id="espera-lista" class="espera-grid"></div>
        </div>

        <div id="v-pacientes" class="view" style="display: none">
          <div class="card">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                flex-wrap: wrap;
                gap: 10px;
              "
            >
              <div class="search-wrapper">
                <input
                  type="text"
                  id="search-pac"
                  class="search-input"
                  placeholder="üîç Buscar por nome, CPF ou telefone..."
                  onkeyup="searchPacientes(this.value)"
                />
                <span class="search-icon">üîç</span>
                <div
                  id="search-results"
                  class="search-results"
                  style="display: none"
                ></div>
              </div>
              <button class="btn btn-p" onclick="modPac()">
                + Novo Paciente
              </button>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>CPF</th>
                  <th>Tel</th>
                  <th>Email</th>
                  <th>A√ß√£o</th>
                </tr>
              </thead>
              <tbody id="t-pac"></tbody>
            </table>
          </div>
        </div>

        <div id="v-profissionais" class="view" style="display: none">
          <div class="card">
            <div style="display: flex; justify-content: space-between">
              <h2>Profissionais</h2>
              <button class="btn btn-p" onclick="modProf()">+ Novo</button>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>CRM</th>
                  <th>Espec.</th>
                  <th>A√ß√£o</th>
                </tr>
              </thead>
              <tbody id="t-prof"></tbody>
            </table>
          </div>
        </div>

        <div id="v-agenda" class="view" style="display: none">
          <div class="card">
            <div
              style="
                display: flex;
                gap: 10px;
                align-items: flex-end;
                flex-wrap: wrap;
                margin-bottom: 15px;
              "
            >
              <div>
                <label>De:</label
                ><input
                  type="date"
                  id="ag-ini"
                  style="width: auto"
                  onchange="loadAgenda()"
                />
              </div>
              <div>
                <label>At√©:</label
                ><input
                  type="date"
                  id="ag-fim"
                  style="width: auto"
                  onchange="loadAgenda()"
                />
              </div>
              <div>
                <label>Profissional:</label
                ><select
                  id="ag-filter-prof"
                  style="width: auto"
                  onchange="loadAgenda()"
                >
                  <option value="">Todos</option>
                </select>
              </div>
              <button
                class="btn btn-i"
                style="margin-bottom: 10px"
                onclick="toggleAgendaView()"
              >
                üìä Alternar Visualiza√ß√£o
              </button>
              <button
                class="btn btn-p"
                style="margin-left: auto; margin-bottom: 10px"
                onclick="modAg()"
              >
                + Agendar
              </button>
            </div>

            <div
              id="agenda-timeline"
              style="display: none"
              class="timeline-container"
            >
              <div id="agenda-timeline-content"></div>
            </div>

            <div id="agenda-table">
              <table>
                <thead>
                  <tr>
                    <th>Data / Hora</th>
                    <th>Paciente</th>
                    <th>Profissional</th>
                    <th>Status</th>
                    <th width="100">A√ß√£o</th>
                  </tr>
                </thead>
                <tbody id="t-ag"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="v-atendimento" class="view" style="display: none">
          <div class="card" id="atend-sel-area">
            <h2>Iniciar Atendimento</h2>
            <div style="display: flex; gap: 10px">
              <select id="atend-pac-sel"></select
              ><button class="btn btn-p" onclick="startAtend()">
                Abrir Prontu√°rio
              </button>
            </div>
          </div>
          <div id="atend-main" style="display: none">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
              "
            >
              <button class="btn btn-s" onclick="closeAtend()">‚¨Ö Voltar</button>
              <h2
                id="atend-pac-name"
                style="color: var(--primary); margin: 0"
              ></h2>
            </div>

            <div
              class="card"
              style="background: #374151; border-left: 5px solid #ef4444"
            >
              <div class="row">
                <div class="col">
                  <label style="color: #ef4444; font-weight: bold"
                    >‚ö† ALERGIAS</label
                  >
                  <input
                    id="at-alergias"
                    placeholder="Nenhuma alergia registrada"
                    style="background: #1f2937; border: 1px solid #ef4444"
                  />
                </div>
                <div class="col">
                  <label style="color: #f59e0b; font-weight: bold"
                    >üíä USO CONT√çNUO</label
                  >
                  <input
                    id="at-meds-uso"
                    readonly
                    style="background: #1f2937; color: #ccc; border: none"
                  />
                </div>
              </div>
            </div>

            <div
              class="card"
              style="background: linear-gradient(to right, #1f2937, #111827)"
            >
              <h4
                style="
                  color: var(--muted);
                  margin-bottom: 10px;
                  text-transform: uppercase;
                  font-size: 0.8rem;
                "
              >
                Sinais Vitais do Dia
              </h4>
              <div class="row">
                <div class="col">
                  <label>Peso (kg)</label
                  ><input
                    type="number"
                    id="at-peso"
                    step="0.1"
                    placeholder="0.0"
                  />
                </div>
                <div class="col">
                  <label>Altura (m)</label
                  ><input
                    type="number"
                    id="at-altura"
                    step="0.01"
                    placeholder="0.00"
                  />
                </div>
                <div class="col">
                  <label>PA (mmHg)</label
                  ><input
                    type="text"
                    id="at-pa"
                    placeholder="120x80"
                    class="mask-pa"
                  />
                </div>
                <div class="col">
                  <label>Temp (¬∞C)</label
                  ><input
                    type="number"
                    id="at-temp"
                    step="0.1"
                    placeholder="36.5"
                  />
                </div>
                <div class="col">
                  <label>Sat O2 (%)</label
                  ><input type="number" id="at-sat" placeholder="98" />
                </div>
              </div>
            </div>

            <div class="dash-content" style="grid-template-columns: 2fr 1fr">
              <div class="card">
                <div class="row">
                  <div class="col">
                    <label>üìù Evolu√ß√£o Cl√≠nica / Anamnese</label>
                    <textarea
                      id="at-evo"
                      rows="8"
                      style="font-size: 1.1rem"
                    ></textarea>
                  </div>
                </div>
                <div class="row">
                  <div class="col">
                    <label>üíä Prescri√ß√£o M√©dica</label>
                    <textarea id="at-pres" rows="5"></textarea>
                  </div>
                </div>
                <div class="row">
                  <div class="col">
                    <label>üî¨ Pedido de Exames</label>
                    <textarea id="at-exm" rows="4"></textarea>
                  </div>
                </div>
                <div style="margin-bottom: 10px">
                  <label>Diagn√≥stico (CID/Descri√ß√£o)</label
                  ><input id="atend-cid" />
                </div>

                <div
                  style="
                    text-align: right;
                    border-top: 1px solid var(--border);
                    padding-top: 15px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                  "
                >
                  <select id="at-prof" style="width: auto; margin: 0"></select>
                  <div>
                    <button class="btn btn-s" onclick="imprimirReceita()">
                      üñ®Ô∏è Imprimir
                    </button>
                    <button
                      class="btn btn-p"
                      onclick="saveAtend()"
                      style="padding: 10px 30px; font-size: 1rem"
                    >
                      üíæ SALVAR CONSULTA
                    </button>
                  </div>
                </div>
              </div>

              <div class="card" style="max-height: 800px; overflow-y: auto">
                <h3
                  style="
                    position: sticky;
                    top: 0;
                    background: var(--bg-card);
                    padding-bottom: 10px;
                    border-bottom: 1px solid var(--border);
                  "
                >
                  üìú Hist√≥rico
                </h3>
                <div
                  id="at-hist"
                  style="
                    display: flex;
                    flex-direction: column;
                    gap: 10px;
                    margin-top: 10px;
                  "
                ></div>
              </div>
            </div>
          </div>
        </div>

        <div id="v-financeiro" class="view" style="display: none">
          <div class="grid" style="margin-bottom: 20px">
            <div class="card" style="border-left: 4px solid #10b981">
              <h4 style="color: var(--muted); font-size: 0.8rem">
                Concretizado (Pago)
              </h4>
              <h2 style="color: #10b981" id="fin-total-pago">R$ 0,00</h2>
            </div>
            <div class="card" style="border-left: 4px solid #f59e0b">
              <h4 style="color: var(--muted); font-size: 0.8rem">
                Pendente (Aberto)
              </h4>
              <h2 style="color: #f59e0b" id="fin-total-pendente">R$ 0,00</h2>
            </div>
            <div class="card" style="border-left: 4px solid #ef4444">
              <h4 style="color: var(--muted); font-size: 0.8rem">
                Vencido (Atrasado)
              </h4>
              <h2 style="color: #ef4444" id="fin-total-vencido">R$ 0,00</h2>
            </div>
            <div class="card" style="border-left: 4px solid #3b82f6">
              <h4 style="color: var(--muted); font-size: 0.8rem">
                Balan√ßo Previsto
              </h4>
              <h2 style="color: #3b82f6" id="fin-total-geral">R$ 0,00</h2>
            </div>
          </div>

          <div class="card">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
                gap: 15px;
                margin-bottom: 20px;
                border-bottom: 1px solid var(--border);
                padding-bottom: 15px;
              "
            >
              <div class="tabs" style="border: none; margin: 0">
                <div
                  class="tab active"
                  onclick="tabFin('receber', this)"
                  style="font-weight: 600"
                >
                  ‚¨áÔ∏è A Receber
                </div>
                <div
                  class="tab"
                  onclick="tabFin('pagar', this)"
                  style="font-weight: 600"
                >
                  ‚¨ÜÔ∏è A Pagar
                </div>
                <div
                  class="tab"
                  onclick="tabFin('caixa', this)"
                  style="font-weight: 600"
                >
                  üèß Livro Caixa
                </div>
              </div>

              <div style="display: flex; gap: 10px; align-items: center">
                <select
                  id="fin-mes"
                  onchange="loadFin()"
                  style="width: 140px; margin: 0"
                >
                  <option value="1">Janeiro</option>
                  <option value="2">Fevereiro</option>
                  <option value="3">Mar√ßo</option>
                  <option value="4">Abril</option>
                  <option value="5">Maio</option>
                  <option value="6">Junho</option>
                  <option value="7">Julho</option>
                  <option value="8">Agosto</option>
                  <option value="9">Setembro</option>
                  <option value="10">Outubro</option>
                  <option value="11">Novembro</option>
                  <option value="12">Dezembro</option>
                </select>
                <select
                  id="fin-ano"
                  onchange="loadFin()"
                  style="width: 100px; margin: 0"
                >
                  <option value="2024">2024</option>
                  <option value="2025" selected>2025</option>
                  <option value="2026">2026</option>
                </select>
                <button class="btn btn-p" onclick="modFin()">
                  + Novo Lan√ßamento
                </button>
              </div>
            </div>

            <div style="overflow-x: auto">
              <table id="t-fin-table" style="min-width: 800px">
                <thead id="t-fin-head"></thead>
                <tbody id="t-fin"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="v-relatorios" class="view" style="display: none">
          <div class="card">
            <div
              class="no-print"
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                border-bottom: 1px solid var(--border);
                padding-bottom: 15px;
              "
            >
              <h2 style="margin: 0">üìä Central de Relat√≥rios</h2>
              <div style="display: flex; gap: 10px; align-items: center">
                <select id="rel-tipo" style="margin: 0; width: 180px">
                  <option value="agendamentos">Agendamentos</option>
                  <option value="financeiro">Financeiro Detalhado</option>
                  <option value="profissionais">Produtividade M√©dica</option>
                  <option value="convenios">Utiliza√ß√£o Conv√™nios</option>
                  <option value="pacientes">Base de Pacientes</option>
                  <option value="aniversariantes">Aniversariantes</option>
                </select>
                <input
                  type="date"
                  id="rel-ini"
                  style="margin: 0; width: 140px"
                />
                <span style="color: var(--muted)">at√©</span>
                <input
                  type="date"
                  id="rel-fim"
                  style="margin: 0; width: 140px"
                />

                <button class="btn btn-p" onclick="gerarRel()">üîç Gerar</button>
                <button class="btn btn-s" onclick="window.print()">üñ®Ô∏è</button>
                <button class="btn btn-s" onclick="exportarCSV()">
                  üì• Excel
                </button>
              </div>
            </div>

            <div
              id="rel-header-print"
              style="display: none; text-align: center; margin-bottom: 20px"
            >
              <h2 id="print-title">Relat√≥rio</h2>
              <p id="print-period"></p>
              <hr />
            </div>

            <div
              id="rel-kpi-area"
              class="grid"
              style="
                margin-bottom: 20px;
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
              "
            ></div>

            <div
              id="rel-chart-container"
              style="height: 300px; margin-bottom: 30px; display: none"
            >
              <canvas id="rel-chart"></canvas>
            </div>

            <div id="printable-area">
              <table id="rel-tab" style="width: 100%; font-size: 0.9rem">
                <thead></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="v-cadastros" class="view" style="display: none">
          <div class="card">
            <div class="tabs">
              <div class="tab active" onclick="loadAux('especialidades', this)">
                Especialidades
              </div>
              <div class="tab" onclick="loadAux('convenios', this)">
                Conv√™nios
              </div>
              <div class="tab" onclick="loadAux('salas', this)">Salas</div>
              <div class="tab" onclick="loadAux('procedimentos', this)">
                Procedimentos
              </div>
            </div>
            <div id="aux-simple-ctrl" style="display: flex; gap: 10px">
              <input
                type="text"
                id="aux-nome"
                placeholder="Novo item..."
              /><button class="btn btn-p" onclick="salvAux()">Adicionar</button>
            </div>
            <div id="aux-conv-ctrl" style="display: none; margin-bottom: 10px">
              <button class="btn btn-p" onclick="modConv()">
                + Novo Conv√™nio
              </button>
            </div>
            <table>
              <tbody id="t-aux"></tbody>
            </table>
          </div>
        </div>
      </main>
    </div>

    <div id="m-wifi-tv" class="overlay">
      <div class="modal" style="text-align: center; max-width: 450px">
        <div class="modal-head">
          <h2>üì° Conectar TV Wi-Fi</h2>
          <button class="btn btn-d" onclick="closeM('m-wifi-tv')">X</button>
        </div>
        <p style="color: var(--muted); margin-bottom: 15px">
          Para usar a TV sem cabos, certifique-se que ela est√° no mesmo Wi-Fi
          deste computador.
        </p>
        <div
          style="
            background: var(--bg-input);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
          "
        >
          <p style="font-size: 0.9rem; color: var(--muted)">
            Abra o navegador da TV e digite:
          </p>
          <h2
            id="tv-url-display"
            style="
              color: var(--primary);
              font-size: 1.8rem;
              margin: 10px 0;
              letter-spacing: 1px;
            "
          >
            Carregando...
          </h2>
        </div>
        <div
          style="
            background: white;
            padding: 10px;
            display: inline-block;
            border-radius: 8px;
          "
        >
          <img
            id="tv-qr"
            src=""
            alt="QR Code"
            width="200"
            height="200"
            style="display: none"
          />
        </div>
      </div>
    </div>

    <div id="m-conta" class="overlay">
      <div class="modal">
        <div class="modal-head">
          <h2>üë§ Minha Conta</h2>
          <button class="btn btn-d" onclick="closeM('m-conta')">X</button>
        </div>

        <div class="tabs" style="margin-top: 10px">
          <div class="tab active" onclick="subTab(this,'c-dados')">
            Dados da Cl√≠nica
          </div>
          <div class="tab" onclick="subTab(this,'c-senha')">Seguran√ßa</div>
          <div class="tab" onclick="subTab(this,'c-users'); loadUsers()">
            Usu√°rios
          </div>
        </div>

        <div id="c-dados" class="tab-content active">
          <label>Nome da Cl√≠nica</label><input id="conf-nome" />
          <label>CNPJ</label><input id="conf-cnpj" /> <label>Endere√ßo</label
          ><input id="conf-end" /> <label>Telefone</label
          ><input id="conf-tel" class="mask-tel" />
          <button
            class="btn btn-p"
            style="width: 100%; margin-top: 10px"
            onclick="salvarConfig()"
          >
            Salvar Dados
          </button>
        </div>

        <div id="c-senha" class="tab-content">
          <label>Senha Antiga</label
          ><input
            type="password"
            id="senha-antiga"
            placeholder="Sua senha atual"
          />
          <label>Nova Senha</label
          ><input type="password" id="senha-nova" placeholder="Nova senha" />
          <label>Confirmar Nova Senha</label
          ><input
            type="password"
            id="senha-confirma"
            placeholder="Repita a nova senha"
          />
          <button
            class="btn btn-p"
            style="width: 100%; margin-top: 10px"
            onclick="salvarNovaSenha()"
          >
            Alterar Senha
          </button>
        </div>

        <div id="c-users" class="tab-content">
          <div
            style="
              background: #111827;
              padding: 15px;
              border: 1px solid #374151;
              border-radius: 8px;
              margin-bottom: 20px;
            "
          >
            <p style="color: #f59e0b; font-weight: bold; font-size: 0.9rem">
              üîó ACESSO EM REDE
            </p>
            <p style="color: #9ca3af; font-size: 0.85rem; margin-bottom: 5px">
              Para acessar o sistema em outro computador, permane√ßa com ele
              rodando aqui e no outro computador acesse:
            </p>
            <h3
              id="link-rede-display"
              style="color: #10b981; user-select: text"
            >
              Carregando...
            </h3>
            <small style="color: #6b7280"
              >CUIDADO PRA N√ÉO QUEBRAR O SISTEMA: N√£o feche a janela preta neste
              computador principal.</small
            >
          </div>

          <div
            style="
              background: var(--bg-input);
              padding: 15px;
              border-radius: 8px;
              margin-bottom: 15px;
            "
          >
            <h4 style="margin-bottom: 10px; color: var(--primary)">
              Novo Usu√°rio
            </h4>
            <p style="color: #f59e0b; font-size: 0.8rem; margin-bottom: 10px">
              ‚ö† OBS: Ao criar usu√°rio que n√£o seja admin, escolha abaixo as
              telas que ele pode ter acesso.
            </p>

            <div
              style="
                display: flex;
                gap: 10px;
                margin-bottom: 15px;
                flex-wrap: wrap;
              "
            >
              <input
                id="u-new-user"
                placeholder="Login (ex: recepcionista)"
                style="margin: 0; flex: 1"
              />
              <input
                id="u-new-pass"
                type="password"
                placeholder="Senha"
                style="margin: 0; flex: 1"
              />
              <select id="u-new-role" style="margin: 0; width: 120px">
                <option value="user">Comum</option>
                <option value="admin">Admin</option>
              </select>
            </div>

            <div
              style="
                margin-bottom: 15px;
                padding: 10px;
                border: 1px solid var(--border);
                border-radius: 6px;
              "
            >
              <label style="color: white; margin-bottom: 5px"
                >Liberar Telas:</label
              >
              <div style="display: flex; gap: 15px; flex-wrap: wrap">
                <label
                  style="
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 5px;
                    color: #ddd;
                  "
                >
                  <input
                    type="checkbox"
                    class="perm-check"
                    value="agenda"
                    checked
                  />
                  Agenda
                </label>
                <label
                  style="
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 5px;
                    color: #ddd;
                  "
                >
                  <input
                    type="checkbox"
                    class="perm-check"
                    value="pacientes"
                    checked
                  />
                  Pacientes
                </label>
                <label
                  style="
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 5px;
                    color: #ddd;
                  "
                >
                  <input
                    type="checkbox"
                    class="perm-check"
                    value="financeiro"
                  />
                  Financeiro
                </label>
                <label
                  style="
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 5px;
                    color: #ddd;
                  "
                >
                  <input
                    type="checkbox"
                    class="perm-check"
                    value="relatorios"
                  />
                  Relat√≥rios
                </label>
                <label
                  style="
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 5px;
                    color: #ddd;
                  "
                >
                  <input
                    type="checkbox"
                    class="perm-check"
                    value="profissionais"
                  />
                  Profissionais
                </label>
              </div>
            </div>

            <button class="btn btn-p" onclick="addUser()" style="width: 100%">
              + Criar Usu√°rio
            </button>
          </div>

          <table style="width: 100%">
            <thead>
              <tr>
                <th>Usu√°rio</th>
                <th>Tipo</th>
                <th>A√ß√£o</th>
              </tr>
            </thead>
            <tbody id="lista-usuarios"></tbody>
          </table>
        </div>
      </div>
    </div>
    <div id="m-fin" class="overlay">
      <div class="modal">
        <div class="modal-head">
          <h2>Financeiro</h2>
          <button class="btn btn-d" onclick="closeM('m-fin')">X</button>
        </div>
        <label>Tipo</label
        ><select id="f-tipo" onchange="toggleFin()">
          <option value="receber">Receita</option>
          <option value="pagar">Despesa</option>
        </select>
        <div id="d-pac">
          <label>Paciente</label
          ><select id="f-pac"></select>
        </div>
        <div id="d-forn" style="display: none">
          <label>Fornecedor</label><input id="f-forn" />
        </div>
        <div class="row">
          <div class="col"><label>Desc</label><input id="f-desc" /></div>
          <div class="col">
            <label>Valor</label><input type="number" id="f-val" step="0.01" />
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label>Venc</label
            ><input type="date" id="f-venc" style="color-scheme: dark" />
          </div>
          <div class="col">
            <label>Parc</label><input type="number" id="f-parc" value="1" />
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label>Categoria <span style="color: red">*</span></label
            ><input id="f-cat" />
          </div>
          <div class="col"><label>Centro Custo</label><input id="f-cc" /></div>
          <div class="col">
            <label>Forma</label
            ><select id="f-forma">
              <option>Dinheiro</option>
              <option>Pix</option>
              <option>Cart√£o</option>
            </select>
          </div>
        </div>
        <button class="btn btn-p" style="width: 100%" onclick="saveFin()">
          Salvar Lan√ßamento
        </button>
      </div>
    </div>
    <div id="m-transf" class="overlay">
      <div class="modal">
        <div class="modal-head">
          <h2>Reagendar</h2>
          <button class="btn btn-d" onclick="closeM('m-transf')">X</button>
        </div>
        <input type="hidden" id="tr-id" /><input
          type="hidden"
          id="tr-pac-nome"
        /><input type="hidden" id="tr-pac-tel" /><label>Profissional</label
        ><select id="tr-prof"></select>
        <div class="row">
          <div class="col">
            <label>Data</label
            ><input type="date" id="tr-data" style="color-scheme: dark" />
          </div>
          <div class="col">
            <label>Hora</label
            ><input type="time" id="tr-hora" style="color-scheme: dark" />
          </div>
        </div>
        <div style="text-align: right; margin-top: 10px">
          <button class="btn btn-p" onclick="confTransf()">Confirmar</button>
        </div>
      </div>
    </div>
    <div id="m-fim" class="overlay">
      <div class="modal" style="max-width: 500px">
        <div class="modal-head">
          <h2>üèÅ Finalizar Atendimento</h2>
          <button class="btn btn-d" onclick="closeM('m-fim')">X</button>
        </div>
        <input type="hidden" id="fim-id" />

        <input type="hidden" id="fim-pac-id" />
        <input type="hidden" id="fim-prof-id" />
        <div
          style="
            background: var(--bg-input);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
          "
        >
          <h3 style="color: var(--primary); margin-bottom: 10px">
            üí∏ Checkout Financeiro
          </h3>

          <div class="row">
            <div class="col">
              <label>Valor Final (R$)</label>
              <input
                type="number"
                id="fim-valor"
                step="0.01"
                style="font-weight: bold; color: #10b981"
              />
            </div>
            <div class="col">
              <label>Status</label>
              <select id="fim-status-fin" onchange="togglePagamento()">
                <option value="Pago">‚úÖ Pago Agora</option>
                <option value="Pendente">‚è≥ Pendente / Conv√™nio</option>
              </select>
            </div>
          </div>

          <div class="row" id="fim-div-forma">
            <div class="col">
              <label>Forma de Pagamento</label>
              <select id="fim-forma">
                <option value="Dinheiro">üíµ Dinheiro</option>
                <option value="Pix">üí† Pix</option>
                <option value="Cart√£o Cr√©dito">üí≥ Cart√£o Cr√©dito</option>
                <option value="Cart√£o D√©bito">üí≥ Cart√£o D√©bito</option>
                <option value="Conv√™nio">üè• Conv√™nio</option>
              </select>
            </div>
          </div>
        </div>

        <label>
          <input type="checkbox" id="fim-retorno" onchange="toggleRetorno()" />
          Agendar Retorno?
        </label>

        <div
          id="fim-area-retorno"
          style="
            display: none;
            margin-top: 10px;
            border-top: 1px solid var(--border);
            padding-top: 10px;
          "
        >
          <div class="row">
            <div class="col">
              <label>Data Retorno</label>
              <input type="date" id="fim-data" style="color-scheme: dark" />
            </div>
            <div class="col">
              <label>Hora</label>
              <input type="time" id="fim-hora" style="color-scheme: dark" />
            </div>
          </div>
        </div>

        <button
          class="btn btn-p"
          onclick="confFim()"
          style="width: 100%; margin-top: 20px; font-size: 1.1rem"
        >
          Confirmar e Baixar
        </button>
      </div>
    </div>
    <div id="m-pac" class="overlay">
      <div class="modal">
        <div class="modal-head">
          <h2>Paciente</h2>
          <button class="btn btn-d" onclick="closeM('m-pac')">X</button>
        </div>
        <input type="hidden" id="p-id" />
        <div class="row">
          <div class="col"><label>Nome</label><input id="p-nome" /></div>
          <div class="col">
            <label>CPF</label><input id="p-cpf" class="mask-cpf" />
          </div>
        </div>
        <div class="row">
          <div class="col"><label>RG</label><input id="p-rg" /></div>
          <div class="col">
            <label>Nasc</label
            ><input type="date" id="p-nasc" style="color-scheme: dark" />
          </div>
          <div class="col">
            <label>Sexo</label
            ><select id="p-sexo">
              <option>M</option>
              <option>F</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label>Tel</label><input id="p-tel1" class="mask-tel" />
          </div>
          <div class="col"><label>Email</label><input id="p-email" /></div>
        </div>
        <label>End</label><input id="p-end" /><label>Conv</label
        ><select id="p-conv"></select
        ><label>Meds</label><input id="p-meds" /><label>Obs</label
        ><textarea id="p-obs" rows="3"></textarea
        ><button class="btn btn-p" style="width: 100%" onclick="savePac()">
          Salvar
        </button>
      </div>
    </div>
    <div id="m-prof" class="overlay">
      <div class="modal">
        <div class="modal-head">
          <h2>Profissional</h2>
          <button class="btn btn-d" onclick="closeM('m-prof')">X</button>
        </div>
        <input type="hidden" id="pr-id" />
        <div class="tabs" style="margin-top: 1rem">
          <div class="tab active" onclick="subTab(this,'pr-dados')">Dados</div>
          <div class="tab" onclick="subTab(this,'pr-end')">End</div>
          <div class="tab" onclick="subTab(this,'pr-fin')">Fin</div>
        </div>
        <div id="pr-dados" class="tab-content active">
          <div class="row">
            <div class="col"><label>Nome</label><input id="pr-nome" /></div>
            <div class="col"><label>CRM</label><input id="pr-crm" /></div>
          </div>
          <div class="col">
            <label>Valor Consulta (Padr√£o)</label>
            <input type="number" id="pr-valor" step="0.01" placeholder="0.00" />
          </div>
          <div class="row">
            <div class="col">
              <label>CPF</label><input id="pr-cpf" class="mask-cpf" />
            </div>
            <div class="col">
              <label>Nasc</label
              ><input type="date" id="pr-nasc" style="color-scheme: dark" />
            </div>
          </div>
          <div class="row">
            <div class="col"><label>Email</label><input id="pr-email" /></div>
            <div class="col">
              <label>Tel</label><input id="pr-tel" class="mask-tel" />
            </div>
          </div>
          <label>Espec</label
          ><select id="pr-esp"></select
          ><label>Dias</label><input id="pr-dias" />
        </div>
        <div id="pr-end" class="tab-content">
          <label>Endere√ßo</label><input id="pr-rua" />
          <div class="row">
            <div class="col"><label>Bairro</label><input id="pr-bairro" /></div>
            <div class="col"><label>Cidade</label><input id="pr-cid" /></div>
          </div>
        </div>
        <div id="pr-fin" class="tab-content">
          <div class="row">
            <div class="col"><label>Banco</label><input id="pr-banco" /></div>
            <div class="col"><label>Ag</label><input id="pr-ag" /></div>
            <div class="col"><label>CC</label><input id="pr-cc" /></div>
          </div>
          <div class="row">
            <div class="col"><label>Pix</label><input id="pr-pix" /></div>
            <div class="col">
              <label>Com%</label><input type="number" id="pr-comissao" />
            </div>
          </div>
        </div>
        <button
          class="btn btn-p"
          style="width: 100%; margin-top: 1rem"
          onclick="saveProf()"
        >
          Salvar
        </button>
      </div>
    </div>
    <div id="m-conv" class="overlay">
      <div class="modal">
        <div class="modal-head">
          <h2>Conv√™nio</h2>
          <button class="btn btn-d" onclick="closeM('m-conv')">X</button>
        </div>
        <input type="hidden" id="cv-id" />
        <div class="row">
          <div class="col"><label>Nome</label><input id="cv-nome" /></div>
          <div class="col"><label>ANS</label><input id="cv-ans" /></div>
        </div>
        <div class="row">
          <div class="col"><label>CNPJ</label><input id="cv-cnpj" /></div>
          <div class="col">
            <label>Prazo</label><input type="number" id="cv-prazo" />
          </div>
        </div>
        <div class="row">
          <div class="col"><label>Email</label><input id="cv-email" /></div>
          <div class="col"><label>Site</label><input id="cv-site" /></div>
        </div>
        <button class="btn btn-p" style="width: 100%" onclick="saveConv()">
          Salvar
        </button>
      </div>
    </div>
    <div id="m-ag" class="overlay">
      <div class="modal">
        <div class="modal-head">
          <h2>Agendar</h2>
          <button class="btn btn-d" onclick="closeM('m-ag')">X</button>
        </div>
        <label>Paciente</label
        ><select id="a-pac"></select
        ><label>Profissional</label
        ><select id="a-prof"></select>
        <div class="row">
          <div class="col">
            <label>Valor R$</label>
            <input type="number" id="a-valor" step="0.01" />
          </div>
          <div class="col">
            <label>Data</label
            ><input type="date" id="a-data" style="color-scheme: dark" />
          </div>
          <div class="col">
            <label>Hora</label
            ><input type="time" id="a-hora" style="color-scheme: dark" />
          </div>
          <div class="col">
            <label>Dur</label><input type="number" id="a-dur" value="30" />
          </div>
        </div>
        <label>Sala</label
        ><select id="a-sala"></select
        ><button class="btn btn-p" style="width: 100%" onclick="saveAg()">
          Agendar
        </button>
      </div>
    </div>
    <div id="m-baixa" class="overlay">
      <div class="modal" style="width: 400px">
        <div class="modal-head">
          <h2>Baixar</h2>
          <button class="btn btn-d" onclick="closeM('m-baixa')">X</button>
        </div>
        <input type="hidden" id="b-id" /><label>Valor Pago</label
        ><input type="number" id="b-val" step="0.01" /><button
          class="btn btn-p"
          style="width: 100%; margin-top: 10px"
          onclick="confBaixa()"
        >
          Confirmar
        </button>
      </div>
    </div>
    <div id="m-dia" class="overlay">
      <div class="modal">
        <div class="modal-head">
          <h2 id="dia-titulo"></h2>
          <button class="btn btn-d" onclick="closeM('m-dia')">X</button>
        </div>
        <div id="dia-lista"></div>
        <div style="margin-top: 20px; text-align: right">
          <button class="btn btn-p" onclick="modAgDia()">+ Novo</button>
        </div>
      </div>
    </div>
    <div id="m-leitura" class="overlay" style="z-index: 3000">
      <div class="modal">
        <div class="modal-head">
          <h3>Hist√≥rico</h3>
          <button class="btn btn-d" onclick="closeM('m-leitura')">X</button>
        </div>
        <div
          id="conteudo-leitura"
          style="
            white-space: pre-wrap;
            line-height: 1.6;
            background: var(--bg-input);
            padding: 15px;
            border-radius: 8px;
            max-height: 60vh;
            overflow-y: auto;
          "
        ></div>
      </div>
    </div>

    <div id="toast">Notifica√ß√£o</div>
    <div id="print-receita"></div>

    <script>
      let janelaTV = null;
      const API = "/api";
      let curFin = "receber",
        curAux = "especialidades",
        calendar = null,
        curChart = null,
        refreshTimer = null,
        currentAgId = null,
        clinicConfig = {};
      let timelineVisible = false,
        agendaTimelineVisible = false;
      const ICON_WA =
        '<svg class="wa-icon" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.008-.57-.008-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>';
      const el = (id) => document.getElementById(id),
        val = (id) => (el(id) ? el(id).value : "");
      const req = async (u, m = "GET", d = null, s = false) => {
        try {
          const o = {
            method: m,
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "include", // üî• FOR√áA ENVIO DE COOKIES
            cache: "no-cache",
          };
          if (d) o.body = JSON.stringify(d);

          const r = await fetch(API + u, o);

          // Se der 401 e n√£o for a rota de login
          if (
            r.status === 401 &&
            !s &&
            !u.includes("/login") &&
            !u.includes("/check_auth")
          ) {
            console.warn("‚ö†Ô∏è Sess√£o expirou na requisi√ß√£o:", u);

            // Tenta verificar auth
            const authCheck = await fetch(API + "/check_auth", {
              method: "GET",
              credentials: "include",
              cache: "no-cache",
            });

            if (!authCheck.ok) {
              console.error("‚ùå Sess√£o realmente expirou, recarregando...");
              location.reload();
              return null;
            }
          }

          if (r.status === 401 && !s) return null;
          return await r.json();
        } catch (e) {
          if (!s) {
            console.error("Erro na requisi√ß√£o:", e);
            showToast("Erro: " + e, "erro");
          }
          return null;
        }
      };
      function showToast(m, t = "s") {
        const x = el("toast");
        x.innerText = m;
        x.style.backgroundColor = t === "erro" ? "#EF4444" : "#10B981";
        x.className = "show";
        setTimeout(() => (x.className = ""), 3000);
      }
      function mascaraCPF(i) {
        let v = i.value
          .replace(/\D/g, "")
          .replace(/(\d{3})(\d)/, "$1.$2")
          .replace(/(\d{3})(\d)/, "$1.$2")
          .replace(/(\d{3})(\d{1,2})$/, "$1-$2");
        i.value = v;
      }
      function mascaraTel(i) {
        let v = i.value
          .replace(/\D/g, "")
          .replace(/^(\d{2})(\d)/, "($1) $2")
          .replace(/(\d)(\d{4})$/, "$1-$2");
        i.value = v;
      }
      document.addEventListener("input", (e) => {
        if (e.target.classList.contains("mask-cpf")) mascaraCPF(e.target);
        if (e.target.classList.contains("mask-tel")) mascaraTel(e.target);
      });

      document.addEventListener("input", (e) => {
        if (e.target.classList.contains("mask-cpf")) mascaraCPF(e.target);
        if (e.target.classList.contains("mask-tel")) mascaraTel(e.target);
      });

      // --- COLE AQUI O C√ìDIGO NOVO ---
      if (el("a-prof")) {
        el("a-prof").addEventListener("change", function () {
          const opt = this.options[this.selectedIndex];
          // Verifica se tem op√ß√£o selecionada e se tem valor no dataset
          if (opt && opt.dataset.valor) {
            // Preenche o campo de valor (se ele existir)
            if (el("a-valor")) el("a-valor").value = opt.dataset.valor;
          }
        });
      }

      function imprimirReceita() {
        const p = el("atend-pac-name").innerText.replace("Paciente: ", ""),
          pr = val("at-pres"),
          ex = val("at-exm"),
          dt = new Date().toLocaleDateString();
        const h = `<div style="text-align:center;margin-bottom:3rem;border-bottom:2px solid #000;padding-bottom:1rem"><h2>${(
          clinicConfig.nome_clinica || "Cl√≠nica"
        ).toUpperCase()}</h2><p>${clinicConfig.endereco || ""} - ${
          clinicConfig.telefone || ""
        }</p></div><div style="margin-bottom:2rem"><strong>Paciente:</strong> ${p}<br><strong>Data:</strong> ${dt}</div>${
          pr
            ? `<div style="margin-bottom:2rem"><h3>üíä Prescri√ß√£o</h3><pre style="font-family:inherit;white-space:pre-wrap">${pr}</pre></div>`
            : ""
        }${
          ex
            ? `<div style="margin-bottom:2rem"><h3>üî¨ Exames</h3><pre style="font-family:inherit;white-space:pre-wrap">${ex}</pre></div>`
            : ""
        }<div style="margin-top:4rem;text-align:center;border-top:1px solid #000;width:50%;margin:auto;padding-top:10px">Assinatura</div>`;
        el("print-receita").innerHTML = h;
        window.print();
      }

      const fill = async (id, u) => {
        const l = await req(u);
        if (el(id))
          // Substitua o trecho do .map por este novo que inclui o data-valor
          el(id).innerHTML = (l || [])
            .map(
              (i) =>
                `<option value="${i.id}" data-tel="${
                  i.telefone_principal || ""
                }" data-valor="${i.valor_padrao || 0}">${i.nome}</option>`
            )
            .join("");
      };

      function calcularTempoEspera(dataHoraInicio, status) {
        if (status === "Cancelado" || status === "Finalizado") return null;
        const inicio = new Date(dataHoraInicio.replace(" ", "T"));
        const agora = new Date();
        const minutos = Math.floor((agora - inicio) / 60000);
        if (minutos < 0) return null;
        let classe = "tempo-ok",
          icone = "‚è±Ô∏è";
        if (minutos > 30) {
          classe = "tempo-alerta";
          icone = "‚ö†Ô∏è";
        }
        if (minutos > 60) {
          classe = "tempo-critico";
          icone = "üö®";
        }
        return { minutos, classe, icone };
      }
      function formatarTempo(minutos) {
        if (minutos < 60) return `${minutos}min`;
        const horas = Math.floor(minutos / 60);
        const mins = minutos % 60;
        return `${horas}h ${mins}min`;
      }

      let tvWindow = null;

      function abrirJanelaTV() {
        if (tvWindow == null || tvWindow.closed) {
          // Abre SOMENTE UMA VEZ
          tvWindow = window.open("/tv", "JanelaTV", "width=1000,height=700");
        } else {
          // S√≥ foca na janela existente
          tvWindow.focus();
        }
      }

      async function abrirModalTV() {
        el("m-wifi-tv").style.display = "flex";
        let ip = clinicConfig.ip_rede || "http://localhost:5000";
        if (ip.endsWith("/")) ip = ip.slice(0, -1);
        const urlTV = `${ip}/tv`;
        el("tv-url-display").innerText = urlTV.replace("http://", "");
        const qrImg = el("tv-qr");
        qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(
          urlTV
        )}`;
        qrImg.style.display = "inline-block";
      }

      async function chamarPaciente(id, nome) {
        showToast(`üì¢ Chamando ${nome} no painel...`);

        // Chama a rota espec√≠fica que atualiza o carimbo de tempo
        await req("/agenda/chamar_painel", "POST", { id: id });

        loadEspera(); // Atualiza a tela local
      }

      let searchTimeout;
      async function searchPacientes(termo) {
        clearTimeout(searchTimeout);
        const results = el("search-results");
        if (termo.length < 2) {
          results.style.display = "none";
          loadPac("");
          return;
        }
        searchTimeout = setTimeout(async () => {
          const lista = await req("/pacientes?filtro=" + termo);
          if (!lista || lista.length === 0) {
            results.innerHTML =
              '<div style="padding:15px; text-align:center; color:var(--muted)">Nenhum resultado</div>';
            results.style.display = "block";
            el("t-pac").innerHTML =
              '<tr><td colspan="5" style="text-align:center; color:var(--muted)">Nenhum paciente encontrado</td></tr>';
            return;
          }
          results.innerHTML = lista
            .slice(0, 5)
            .map((p) => {
              const nomeHighlight = p.nome.replace(
                new RegExp(termo, "gi"),
                (match) => `<span class="search-highlight">${match}</span>`
              );
              // CORRE√á√ÉO AQUI:
              return `<div class="search-result-item" onclick='editPac(${escapeDados(
                p
              )})'><strong>${nomeHighlight}</strong><br><small style="color:var(--muted)">CPF: ${
                p.cpf || "N/A"
              } | Tel: ${p.telefone_principal || "N/A"}</small></div>`;
            })
            .join("");
          results.style.display = "block";
          loadPac(termo);
        }, 300);
      }
      document.addEventListener("click", (e) => {
        if (!e.target.closest(".search-wrapper")) {
          el("search-results").style.display = "none";
        }
      });

      function toggleTimeline() {
        timelineVisible = !timelineVisible;
        el("timeline-view").style.display = timelineVisible ? "block" : "none";
        el("espera-lista").style.display = timelineVisible ? "none" : "grid";
        if (timelineVisible) {
          fill("timeline-prof-filter", "/profissionais");
          loadTimeline();
        }
      }
      function toggleAgendaView() {
        agendaTimelineVisible = !agendaTimelineVisible;
        el("agenda-timeline").style.display = agendaTimelineVisible
          ? "block"
          : "none";
        el("agenda-table").style.display = agendaTimelineVisible
          ? "none"
          : "block";
        if (agendaTimelineVisible) loadAgendaTimeline();
      }

      async function loadTimeline() {
        const profId = val("timeline-prof-filter");
        const lista = await req(
          "/sala_espera" + (profId ? "?prof_id=" + profId : "")
        );
        const horas = {};
        for (let h = 7; h <= 20; h++) {
          horas[h] = [];
        }
        (lista || []).forEach((a) => {
          const hora = parseInt(a.data_hora_inicio.substring(11, 13));
          if (horas[hora]) horas[hora].push(a);
        });
        el("timeline-content").innerHTML = Object.keys(horas)
          .map((h) => {
            const eventos = horas[h];
            return `<div class="timeline-hour">${h}:00</div><div class="timeline-slot">${
              eventos.length
                ? eventos
                    .map(
                      (e) =>
                        `<div class="timeline-event" onclick="verDetalhesAgendamento(${
                          e.id
                        })"><div class="timeline-event-name">${
                          e.paciente_nome
                        }</div><div class="timeline-event-prof">üë®‚Äç‚öïÔ∏è ${
                          e.profissional_nome
                        } | ${e.data_hora_inicio.substring(11, 16)}</div></div>`
                    )
                    .join("")
                : '<div class="timeline-empty">Hor√°rio livre</div>'
            }</div>`;
          })
          .join("");
      }

      async function loadAgendaTimeline() {
        const i = val("ag-ini"),
          f = val("ag-fim"),
          p = val("ag-filter-prof");
        const lista = await req(`/agenda?inicio=${i}&fim=${f}&prof_id=${p}`);
        const horas = {};
        for (let h = 7; h <= 20; h++) {
          horas[h] = [];
        }
        (lista || []).forEach((a) => {
          const hora = parseInt(a.data_hora_inicio.substring(11, 13));
          if (horas[hora]) horas[hora].push(a);
        });
        el("agenda-timeline-content").innerHTML =
          `<div class="timeline-grid">` +
          Object.keys(horas)
            .map((h) => {
              const eventos = horas[h];
              return `<div class="timeline-hour">${h}:00</div><div class="timeline-slot">${
                eventos.length
                  ? eventos
                      .map(
                        (e) =>
                          // CORRE√á√ÉO AQUI:
                          `<div class="timeline-event" onclick='editAg(${escapeDados(
                            e
                          )})'><div class="timeline-event-name">${
                            e.paciente
                          }</div><div class="timeline-event-prof">üë®‚Äç‚öïÔ∏è ${
                            e.profissional
                          } | ${e.data_hora_inicio.substring(11, 16)} | ${
                            e.status
                          }</div></div>`
                      )
                      .join("")
                  : '<div class="timeline-empty">Hor√°rio livre</div>'
              }</div>`;
            })
            .join("") +
          `</div>`;
      }

      function verDetalhesAgendamento(id) {
        showToast("Clique em A√ß√µes no card para gerenciar", "s");
      }

      async function checkAuth() {
        // Adicionei parametro true para evitar loop infinito
        const u = await req("/check_auth", "GET", null, true);
        if (u && u.user) {
          el("login-screen").style.display = "none";
          el("app-screen").style.display = "flex";
          await loadConfig();

          // --- NOVO: Aplica as permiss√µes vindas do backend ---
          aplicarPermissoes(u.perms, u.role);

          // --- NOVO: Mostra o link de rede no modal ---
          if (clinicConfig && clinicConfig.ip_rede) {
            el("link-rede-display").innerText = clinicConfig.ip_rede;
          } else {
            // Fallback caso config ainda n√£o tenha carregado 100%
            req("/config").then((c) => {
              if (c && c.ip_rede) el("link-rede-display").innerText = c.ip_rede;
            });
          }
          // ----------------------------------------------------

          nav("dashboard", document.querySelector("nav button"));
        } else {
          el("login-screen").style.display = "flex";
          el("app-screen").style.display = "none";
        }
      }
      async function doLogin() {
        const btn = el("btn-entrar");
        btn.innerText = "Entrando...";
        btn.disabled = true;

        const res = await req(
          "/login",
          "POST",
          { username: val("login-user"), password: val("login-pass") },
          true
        );

        if (res && res.msg === "Logado") {
          console.log("‚úÖ Login bem-sucedido!");

          // üî• FOR√áA O NAVEGADOR A SALVAR O COOKIE
          document.cookie =
            "clinicasys_logged=true; max-age=31536000; path=/; SameSite=Lax";

          // Aguarda 500ms para garantir que o cookie foi salvo
          await new Promise((resolve) => setTimeout(resolve, 500));

          // Verifica se realmente est√° autenticado
          const authCheck = await req("/check_auth", "GET", null, true);
          if (authCheck && authCheck.user) {
            console.log("‚úÖ Sess√£o verificada:", authCheck.user);
            checkAuth();
          } else {
            alert(
              "Erro: Login realizado mas sess√£o n√£o foi criada. Tente novamente."
            );
            btn.innerText = "Entrar";
            btn.disabled = false;
          }
        } else {
          alert(
            "Erro: " +
              (res && res.erro ? res.erro : "Usu√°rio ou senha incorretos")
          );
          btn.innerText = "Entrar";
          btn.disabled = false;
        }
      }
      async function doLogout() {
        await req("/logout", "POST");
        location.reload();
      }
      async function loadConfig() {
        clinicConfig = await req("/config");
        if (clinicConfig.nome_clinica)
          el("header-title").innerText = clinicConfig.nome_clinica;
      }
      function abrirModalConta() {
        el("m-conta").style.display = "flex";
        if (clinicConfig) {
          el("conf-nome").value = clinicConfig.nome_clinica || "";
          el("conf-cnpj").value = clinicConfig.cnpj || ""; // <--- Carrega CNPJ
          el("conf-end").value = clinicConfig.endereco || "";
          el("conf-tel").value = clinicConfig.telefone || "";
        }
      }
      async function salvarConfig() {
        if (
          await req("/config/salvar", "POST", {
            nome: val("conf-nome"),
            cnpj: val("conf-cnpj"), // <--- Envia CNPJ
            end: val("conf-end"),
            tel: val("conf-tel"),
          })
        ) {
          showToast("Salvo!");
          loadConfig();
          closeM("m-conta");
        }
      }
      async function salvarNovaSenha() {
        if (val("senha-nova") != val("senha-confirma"))
          return showToast("Senhas diferem", "erro");
        if (
          await req("/mudar_senha", "POST", {
            antiga: val("senha-antiga"),
            nova: val("senha-nova"),
          })
        ) {
          showToast("Senha alterada!");
          closeM("m-conta");
        }
      }

      function nav(v, btn) {
        document
          .querySelectorAll(".view")
          .forEach((x) => (x.style.display = "none"));
        if (el("v-" + v)) el("v-" + v).style.display = "block";
        document
          .querySelectorAll("nav button")
          .forEach((b) => b.classList.remove("active"));
        if (btn) btn.classList.add("active");
        if (refreshTimer) {
          clearInterval(refreshTimer);
          refreshTimer = null;
        }
        if (v == "dashboard") {
          loadDash();
          setTimeout(initCalendar, 100);
        }
        if (v == "espera") {
          loadEspera();
          refreshTimer = setInterval(loadEspera, 30000);
        }
        if (v == "pacientes") loadPac("");
        if (v == "profissionais") loadProf();
        if (v == "cadastros")
          loadAux(
            "especialidades",
            document.querySelector("#v-cadastros .tab")
          );
        if (v == "agenda") {
          const h = new Date().toISOString().split("T")[0];
          if (!val("ag-ini")) el("ag-ini").value = h;
          if (!val("ag-fim")) el("ag-fim").value = h;

          // --- CORRE√á√ÉO DO FILTRO (Mant√©m o "Todos") ---
          const carregarFiltro = async () => {
            const profs = await req("/profissionais");
            let opts = '<option value="">Todos os Profissionais</option>';
            opts += (profs || [])
              .map((p) => `<option value="${p.id}">${p.nome}</option>`)
              .join("");
            el("ag-filter-prof").innerHTML = opts;
          };
          carregarFiltro();
          // ---------------------------------------------

          loadAgenda();
        }
        if (v == "atendimento") fill("atend-pac-sel", "/pacientes");
        if (v == "financeiro")
          tabFin("receber", document.querySelector("#v-financeiro .tab"));
        if (v == "relatorios") {
          el("rel-ini").valueAsDate = new Date();
          el("rel-fim").valueAsDate = new Date();
        }
      }
      function closeM(id) {
        el(id).style.display = "none";
      }
      function subTab(btn, cid) {
        const m = btn.closest(".modal") || btn.closest(".card");
        m.querySelectorAll(".tab").forEach((t) => t.classList.remove("active"));
        btn.classList.add("active");
        m.querySelectorAll(".tab-content").forEach((c) =>
          c.classList.remove("active")
        );
        el(cid).classList.add("active");
      }

      const _hoje = new Date();
      const _localIso = new Date(
        _hoje.getTime() - _hoje.getTimezoneOffset() * 60000
      )
        .toISOString()
        .split("T")[0];
      let selectedDashDate = _localIso;

      // 1. Atualize a fun√ß√£o loadDash (Dashboard Principal)
      async function loadDash() {
        const d = await req("/dashboard_stats");
        if (d) {
          el("d-hoje").innerText = d.hoje;
          el("d-mes").innerText = d.mes;
          el("d-fat").innerText = "R$ " + d.faturamento;
          el("d-pend").innerText = d.pendencias;

          // Atualiza Gr√°fico
          const ctx = el("chart");
          if (curChart) {
            curChart.destroy();
            curChart = null;
          }
          if (ctx && d.grafico) {
            curChart = new Chart(ctx, {
              type: "doughnut", // Mudei para doughnut para variar, fica bonito ao lado do calendario
              data: {
                labels: d.grafico.map((i) => i.nome),
                datasets: [
                  {
                    data: d.grafico.map((i) => i.total),
                    backgroundColor: [
                      "#10B981",
                      "#3B82F6",
                      "#F59E0B",
                      "#EC4899",
                      "#8B5CF6",
                    ],
                  },
                ],
              },
              options: { maintainAspectRatio: false }, // Importante para caber na div
            });
          }
        }

        // Carrega o filtro de profissionais na grid
        fill("dash-filter-prof", "/profissionais");

        // Carrega a grid de hoje
        loadDashGrid();
      }

      // 2. Atualize o Calend√°rio para N√ÉO abrir modal, e sim atualizar a grid
      function initCalendar() {
        if (calendar) return;
        calendar = new FullCalendar.Calendar(el("calendar"), {
          initialView: "dayGridMonth",
          locale: "pt-br",
          height: "100%",
          headerToolbar: {
            left: "prev,next",
            center: "title",
            right: "today",
          },
          // Busca os contadores (Ex: "3 agend.")
          events: async (info, successCallback) => {
            // Pega o valor do filtro atual
            const profId = val("dash-filter-prof");
            // Envia para o backend
            const dados = await req("/agenda/resumo_qtd?prof_id=" + profId);
            successCallback(dados || []);
          },
          // Clique no dia vazio
          dateClick: (info) => {
            selecionarDiaDash(info.dateStr, info.dayEl);
          },
          // Clique na bolinha do contador
          eventClick: (info) => {
            // CORRE√á√ÉO: Garante que pegamos s√≥ a data YYYY-MM-DD, sem hora
            let dataEvento = info.event.startStr;
            if (dataEvento.includes("T")) dataEvento = dataEvento.split("T")[0];

            selecionarDiaDash(dataEvento, null);
          },
        });
        calendar.render();
      }

      // Fun√ß√£o auxiliar para pintar o dia selecionado e carregar a grid
      function selecionarDiaDash(dataIso, elementoHtml) {
        selectedDashDate = dataIso;

        // Limpa sele√ß√£o visual anterior
        document
          .querySelectorAll(".fc-daygrid-day")
          .forEach((el) => (el.style.backgroundColor = ""));

        // Pinta o novo dia (se tivermos o elemento direto)
        if (elementoHtml) {
          elementoHtml.style.backgroundColor = "rgba(16, 185, 129, 0.2)";
        } else {
          // Se veio do clique no evento, buscamos o dia pelo atributo data-date
          const diaEl = document.querySelector(
            `.fc-daygrid-day[data-date='${dataIso}']`
          );
          if (diaEl) diaEl.style.backgroundColor = "rgba(16, 185, 129, 0.2)";
        }

        // Carrega a tabela detalhada l√° embaixo
        loadDashGrid();
      }

      // 3. NOVA FUN√á√ÉO: Carrega a Grid Completa
      async function loadDashGrid() {
        const dataDisplay = selectedDashDate.split("-").reverse().join("/");
        el("dash-date-display").innerText = dataDisplay;

        el("dash-grid-body").innerHTML =
          '<tr><td colspan="6" style="text-align:center; padding:20px;">Carregando...</td></tr>';

        const profId = val("dash-filter-prof");

        // Busca tudo do dia
        const lista = await req(
          `/agenda?inicio=${selectedDashDate}&fim=${selectedDashDate}&prof_id=${profId}`
        );

        // Filtro do Dropdown de Status
        const statusFilter = val("dash-filter-status");

        // CORRE√á√ÉO: Por padr√£o, esconde os cancelados para bater com o n√∫mero do calend√°rio
        // Se o usu√°rio quiser ver cancelados, ele teria que filtrar especificamente (ou removemos da grid padr√£o)
        let listaFiltrada = lista || [];

        if (statusFilter) {
          listaFiltrada = listaFiltrada.filter(
            (a) => a.status === statusFilter
          );
        } else {
          // Se n√£o tem filtro selecionado, mostra S√ì OS ATIVOS (para bater com o calend√°rio)
          listaFiltrada = listaFiltrada.filter((a) => a.status !== "Cancelado");
        }

        if (listaFiltrada.length === 0) {
          el("dash-grid-body").innerHTML =
            '<tr><td colspan="6" style="text-align:center; padding:20px; color:var(--muted)">Nenhum agendamento ativo para este dia.</td></tr>';
          return;
        }

        el("dash-grid-body").innerHTML = listaFiltrada
          .map((a) => {
            // Cores dos status
            let badgeClass = "st-agendado";
            if (a.status === "Confirmado") badgeClass = "st-confirmado";
            if (a.status === "Finalizado") badgeClass = "st-finalizado";
            if (a.status === "Em Atendimento") badgeClass = "st-atendimento";
            if (a.status === "Cancelado") badgeClass = "st-cancelado"; // Caso filtre manualmente

            return `
        <tr style="transition:0.2s; cursor:pointer; border-left: 4px solid ${getCorStatus(
          a.status
        )}">
            <td style="font-weight:bold; font-size:1.1rem">${a.data_hora_inicio.substring(
              11,
              16
            )}</td>
            <td>
                <div style="font-weight:bold">${a.paciente}</div>
            </td>
            <td>${a.profissional}</td>
            <td><span class="status-badge ${badgeClass}">${a.status}</span></td>
            <td style="font-size:0.85rem; color:var(--muted)">
                ${a.sala_nome ? "üö™ " + a.sala_nome : ""} <br>
                ${a.tipo ? "üè∑Ô∏è " + a.tipo : ""}
            </td>
            <td>
                <div class="grid-actions">
                    <button class="btn btn-s" title="Editar/Ver" onclick='editAg(${escapeDados(
                      a
                    )})'>üëÅÔ∏è</button>
                    <button class="btn btn-i" title="Reagendar" onclick='dashReagendar(${escapeDados(
                      a
                    )})'>üîÑ</button>
                    <button class="btn btn-d" title="Cancelar" onclick="delAg(${
                      a.id
                    })">‚ùå</button>
                </div>
            </td>
        </tr>`;
          })
          .join("");
      }

      // Fun√ß√£o Auxiliar para cor da borda
      function getCorStatus(s) {
        if (s === "Confirmado") return "#3B82F6";
        if (s === "Finalizado") return "#10B981";
        if (s === "Cancelado") return "#EF4444";
        return "transparent";
      }

      // Atalho para criar agendamento j√° na data selecionada
      function modAgDash() {
        modAg();
        el("a-data").value = selectedDashDate;
      }

      // Atalho para Reagendar vindo da Dashboard
      function dashReagendar(a) {
        // Precisamos buscar telefone se n√£o vier no objeto 'a'
        // Mas vamos abrir o modal com o que temos
        openTransf(a.id, a.profissional_id, a.data_hora_inicio, a.paciente, "");
      }
      async function loadDashGrid() {
        const dataDisplay = selectedDashDate.split("-").reverse().join("/");
        el("dash-date-display").innerText = dataDisplay;

        el("dash-grid-body").innerHTML =
          '<tr><td colspan="6" style="text-align:center; padding:20px;">Carregando...</td></tr>';

        const profId = val("dash-filter-prof");
        // Reutilizamos a rota de agenda que j√° filtra por data e profissional
        const lista = await req(
          `/agenda?inicio=${selectedDashDate}&fim=${selectedDashDate}&prof_id=${profId}`
        );

        // Filtro de Status no Front-end (pra ser r√°pido)
        const statusFilter = val("dash-filter-status");
        const listaFiltrada = statusFilter
          ? lista.filter((a) => a.status === statusFilter)
          : lista;

        if (!listaFiltrada || listaFiltrada.length === 0) {
          el("dash-grid-body").innerHTML =
            '<tr><td colspan="6" style="text-align:center; padding:20px; color:var(--muted)">Nenhum agendamento para este dia/filtro.</td></tr>';
          return;
        }

        el("dash-grid-body").innerHTML = listaFiltrada
          .map((a) => {
            // Define classes de cor para o badge
            let badgeClass = "st-agendado";
            if (a.status === "Confirmado") badgeClass = "st-confirmado";
            if (a.status === "Finalizado") badgeClass = "st-finalizado";
            if (a.status === "Cancelado") badgeClass = "st-cancelado";
            if (a.status === "Em Atendimento") badgeClass = "st-atendimento";

            // Cria link do WhatsApp se tiver telefone
            // Nota: O backend precisa retornar telefone do paciente na rota /agenda (vamos assumir que sim, ou voc√™ ajusta o backend)
            // Se n√£o tiver telefone vindo na rota agenda, teria que ajustar o backend.py na rota list_ag

            return `
        <tr style="transition:0.2s; cursor:pointer; border-left: 4px solid ${getCorStatus(
          a.status
        )}">
            <td style="font-weight:bold; font-size:1.1rem">${a.data_hora_inicio.substring(
              11,
              16
            )}</td>
            <td>
                <div style="font-weight:bold">${a.paciente}</div>
            </td>
            <td>${a.profissional}</td>
            <td><span class="status-badge ${badgeClass}">${a.status}</span></td>
            <td style="font-size:0.85rem; color:var(--muted)">
                ${a.sala_nome ? "üö™ " + a.sala_nome : ""} <br>
                ${a.tipo ? "üè∑Ô∏è " + a.tipo : ""}
            </td>
            <td>
                <div class="grid-actions">
                    <button class="btn btn-s" title="Editar/Ver" onclick='editAg(${escapeDados(
                      a
                    )})'>üëÅÔ∏è</button>
                    <button class="btn btn-i" title="Reagendar" onclick='dashReagendar(${escapeDados(
                      a
                    )})'>üîÑ</button>
                    <button class="btn btn-d" title="Cancelar" onclick="delAg(${
                      a.id
                    })">‚ùå</button>
                </div>
            </td>
        </tr>
        `;
          })
          .join("");
      }

      // Fun√ß√£o Auxiliar para cor da borda
      function getCorStatus(s) {
        if (s === "Confirmado") return "#3B82F6";
        if (s === "Finalizado") return "#10B981";
        if (s === "Cancelado") return "#EF4444";
        return "transparent";
      }

      // Atalho para criar agendamento j√° na data selecionada
      function modAgDash() {
        modAg();
        el("a-data").value = selectedDashDate;
      }

      // Atalho para Reagendar vindo da Dashboard
      function dashReagendar(a) {
        // Precisamos buscar telefone se n√£o vier no objeto 'a'
        // Mas vamos abrir o modal com o que temos
        openTransf(a.id, a.profissional_id, a.data_hora_inicio, a.paciente, "");
      }
      async function verDia(data) {
        el("m-dia").style.display = "flex";

        const partes = data.split("-");
        el("dia-titulo").innerText = `Agenda de ${partes[2]}/${partes[1]}`;
        el("dia-titulo").dataset.date = data;

        el("dia-lista").innerHTML =
          "<p style='color:var(--muted);text-align:center'>Carregando...</p>";

        const l = await req(`/agenda?inicio=${data}&fim=${data}`);

        if (!l || l.length === 0) {
          el("dia-lista").innerHTML =
            '<p style="color:var(--muted);text-align:center;padding:20px">Nenhum agendamento neste dia.</p>';
        } else {
          el("dia-lista").innerHTML = l
            .map(
              (a) => `
            <div style="background:var(--bg-input); padding:10px; margin-bottom:8px; border-radius:6px; display:flex; justify-content:space-between; align-items:center; border-left:4px solid var(--primary)">
                <div>
                    <strong style="font-size:1.1rem; color:white">${a.data_hora_inicio.substring(
                      11,
                      16
                    )}</strong> 
                    <span style="margin-left:10px">${a.paciente}</span>
                    <div style="font-size:0.8rem; color:var(--muted)">üë®‚Äç‚öïÔ∏è ${
                      a.profissional
                    } | ${a.status}</div>
                </div>
                <button class="btn btn-s" onclick='closeM("m-dia"); editAg(${escapeDados(
                  a
                )})'>‚úé</button>
            </div>
        `
            )
            .join("");
        }
      }
      function modAgDia() {
        const d = el("dia-titulo").dataset.date;
        closeM("m-dia");
        modAg();
        el("a-data").value = d;
      }

      async function loadEspera() {
        const l = await req("/sala_espera");
        const li = el("espera-lista");
        if (!l || !l.length) {
          li.innerHTML =
            '<div style="padding:40px;text-align:center;color:var(--muted)">Vazio</div>';
          return;
        }

        li.innerHTML = l
          .map((a) => {
            const h =
              a.data_hora_inicio.length >= 16
                ? a.data_hora_inicio.substring(11, 16)
                : "--:--";
            const d =
              a.data_hora_inicio.substring(8, 10) +
              "/" +
              a.data_hora_inicio.substring(5, 7);
            const st = a.status || "Agendado";

            let b = "border-agendado";
            if (st == "Cancelado") b = "border-cancelado";
            else if (st == "Finalizado") b = "border-finalizado";
            else if (st == "Em Atendimento") b = "border-atendimento";
            else if (st == "Em Espera") b = "border-espera";
            else if (st == "Confirmado") b = "border-confirmado";

            // Prote√ß√£o para telefone
            const w = a.paciente_tel
              ? `<a href="https://api.whatsapp.com/send?phone=55${a.paciente_tel.replace(
                  /\D/g,
                  ""
                )}" target="_blank" style="margin-left:5px">${ICON_WA}</a>`
              : "";

            const tempo = calcularTempoEspera(a.data_hora_inicio, st);
            const tempoHtml = tempo
              ? `<div class="tempo-espera ${tempo.classe}">${
                  tempo.icone
                } Aguardando ${formatarTempo(tempo.minutos)}</div>`
              : "";

            // Prote√ß√£o contra aspas simples no NOME (Isso quebrava o bot√£o antes)
            const nomeSafe = a.paciente_nome.replace(/'/g, "\\'");

            // Bot√£o de A√ß√£o Principal (Chamar/Rechamar)
            let btnAcao = "";
            if (["Agendado", "Confirmado", "Em Espera"].includes(st)) {
              btnAcao = `<button class="btn-chamar" onclick="chamarPaciente(${a.id}, '${nomeSafe}')">üì£ CHAMAR</button>`;
            } else if (st === "Em Atendimento") {
              btnAcao = `
                 <div style="display:flex; gap:5px; flex-direction:column; margin-top:10px">
                    <button class="btn btn-p" onclick="irParaAtendimento(${a.id}, ${a.paciente_id})">ü©∫ Abrir Prontu√°rio</button>
                    <button class="btn btn-s" style="background:#f59e0b; border:none; font-weight:bold; color:white;" onclick="chamarPaciente(${a.id}, '${nomeSafe}')">üîî RECHAMAR</button>
                 </div>`;
            }

            // Prote√ß√£o dos dados para a fun√ß√£o processarAcao
            const pNomeParam = a.paciente_nome.replace(/'/g, "&#39;"); // Aspas viram c√≥digo HTML seguro
            const pTelParam = (a.paciente_tel || "").replace(/'/g, ""); // Remove aspas do telefone

            return `<div class="espera-card ${b}">
            <div class="ec-header"><span class="ec-time">${h}</span><span class="ec-status-badge">${st}</span></div>
            <div class="ec-date">${d}</div>
            <div class="ec-body"><h3>${
              a.paciente_nome
            }</h3><div class="ec-prof">üìû ${
              a.paciente_tel || "--"
            } ${w}</div><div class="ec-prof">üë®‚Äç‚öïÔ∏è ${
              a.profissional_nome || "-"
            }</div><div class="ec-room">üö™ ${
              a.sala_nome || "-"
            }</div>${tempoHtml}</div>
            ${btnAcao}
            <div class="ec-actions">
                <select onchange="processarAcao(this, ${a.id}, ${
              a.paciente_id
            }, ${a.profissional_id || "null"}, '${
              a.data_hora_inicio
            }', '${pNomeParam}', '${pTelParam}', ${
              a.valor || 0
            })" style="width:100%;background:var(--bg-card);color:white;border:1px solid var(--border);padding:5px;border-radius:4px">
                <optgroup label="A√ß√µes"><option value="" selected disabled>Outras A√ß√µes...</option><option value="Confirmado">‚úÖ Confirmar</option><option value="Em Espera">üèÉ Chegou</option><option value="Em Atendimento">ü©∫ Atender (Sem chamar)</option><option value="Finalizado">üèÅ Finalizar</option><option value="TRANSFERIR">üîÑ Reagendar/Transferir</option><option value="Cancelado">‚ùå Cancelar</option></optgroup>
            </select> 
            </div>
        </div>`;
          })
          .join("");
      }

      async function processarAcao(s, aid, pid, prid, dh, pn, pt, valor) {
        const ac = s.value;

        if (ac == "TRANSFERIR") {
          openTransf(aid, prid, dh, pn, pt);
          s.value = "";
          return;
        }
        if (ac == "Em Atendimento") {
          irParaAtendimento(aid, pid);
          return;
        }
        if (ac == "Finalizado") {
          // CORRE√á√ÉO: Agora passamos PID (paciente) e PRID (profissional) tamb√©m
          openFim(aid, valor, pid, prid);
          s.value = "";
          return;
        }
        if (ac == "Cancelado" && !confirm("Cancelar?")) {
          s.value = "";
          loadEspera();
          return;
        }
        await mudarSt(aid, ac);
      }

      // --- FUN√á√ïES DO CHECKOUT ---

      function openFim(id, valor, pid, prid) {
        el("m-fim").style.display = "flex";
        el("fim-id").value = id;

        // --- CORRE√á√ÉO DE SEGURAN√áA ---
        // Se por algum motivo o PID vier vazio (undefined), tentamos pegar do atributo do select
        if (!pid || pid === "undefined") {
          console.warn("ID do Paciente perdido, tentando recuperar...");
          // Tenta achar o agendamento na lista global se poss√≠vel (opcional)
        }

        el("fim-pac-id").value = pid; // <--- AQUI QUE ELE GUARDA O ID
        el("fim-prof-id").value = prid;

        // Preenche valor e status
        el("fim-valor").value = valor || 0;
        el("fim-status-fin").value = valor && valor > 0 ? "Pago" : "Pendente";

        // Reseta
        el("fim-retorno").checked = false;
        toggleRetorno();
        togglePagamento();
      }

      function togglePagamento() {
        // Apenas cosm√©tico: Se for Pendente/Conv√™nio, talvez esconder op√ß√µes de pix/dinheiro?
        // Por enquanto vamos deixar tudo vis√≠vel, mas voc√™ pode customizar aqui
      }

      function toggleRetorno() {
        el("fim-area-retorno").style.display = el("fim-retorno").checked
          ? "block"
          : "none";
      }

      async function confFim() {
        const btn = document.querySelector("#m-fim .btn-p");
        btn.disabled = true;
        btn.innerText = "Processando...";

        try {
          // 1. AUTO-RECUPERA√á√ÉO (O Pulo do Gato) üò∫
          // Se o ID do Paciente sumiu, vamos buscar ele agora mesmo no servidor
          if (!val("fim-pac-id") || val("fim-pac-id") == "undefined") {
            console.log("üîÑ Recuperando dados perdidos do agendamento...");

            // Busca a lista atualizada da sala de espera
            const listaRecuperacao = await req("/sala_espera");
            const agendamentoReal = listaRecuperacao.find(
              (x) => x.id == val("fim-id")
            );

            if (agendamentoReal) {
              // Preenche os campos ocultos que estavam vazios
              el("fim-pac-id").value = agendamentoReal.paciente_id;
              el("fim-prof-id").value = agendamentoReal.profissional_id;
            } else {
              // Se n√£o achou na sala de espera, tenta buscar na agenda do dia
              const hoje = new Date().toISOString().split("T")[0];
              const listaAgenda = await req(
                `/agenda?inicio=${hoje}&fim=${hoje}`
              );
              const agendamentoAgenda = listaAgenda.find(
                (x) => x.id == val("fim-id")
              );

              if (agendamentoAgenda) {
                el("fim-pac-id").value = agendamentoAgenda.paciente_id;
                el("fim-prof-id").value = agendamentoAgenda.profissional_id;
              }
            }
          }

          // 2. Envia a finaliza√ß√£o
          await req("/agenda/status", "POST", {
            id: val("fim-id"),
            status: "Finalizado",
            valor_final: val("fim-valor"),
            status_financeiro: val("fim-status-fin"),
            forma_pagamento: val("fim-forma"),
          });

          let dataRetorno = null;

          // 3. Agenda o Retorno (Agora com os IDs recuperados)
          if (el("fim-retorno").checked) {
            const dt = val("fim-data");
            const hr = val("fim-hora");
            // Agora o PID estar√° preenchido pela recupera√ß√£o acima
            const pid = parseInt(val("fim-pac-id"));
            const prid = parseInt(val("fim-prof-id"));

            // Valida√ß√£o final silenciosa (se mesmo recuperando falhar, avisa suave)
            if (!pid)
              throw "N√£o foi poss√≠vel identificar o paciente automaticamente.";

            if (dt && hr) {
              const res = await req("/agenda/salvar", "POST", {
                paciente_id: pid,
                profissional_id: prid || 1, // Se n√£o tiver m√©dico, usa admin/padr√£o
                data: dt,
                hora: hr,
                sala_id: 1,
                tipo: "Retorno",
                duracao: 30,
                obs: "Retorno gerado no checkout",
              });

              if (res && res.msg == "Ok") {
                showToast(
                  "‚úÖ Retorno agendado: " + dt.split("-").reverse().join("/")
                );
                dataRetorno = dt;
              }
            } else {
              showToast(
                "Faltou data para o retorno, mas finalizado.",
                "alerta"
              );
            }
          } else {
            showToast("Finalizado com Sucesso! üí∞");
          }

          // 4. Limpeza
          closeM("m-fim");
          loadEspera();
          loadDash();

          // Vai para a agenda se tiver retorno
          if (dataRetorno) {
            el("ag-ini").value = dataRetorno;
            el("ag-fim").value = dataRetorno;
            nav("agenda", document.querySelector("button[onclick*='agenda']"));
          } else {
            if (typeof loadAgenda === "function") loadAgenda();
          }

          if (calendar) calendar.refetchEvents();
        } catch (e) {
          console.error(e);
          alert("Erro: " + e);
        } finally {
          btn.disabled = false;
          btn.innerText = "Confirmar e Baixar";
        }
      }
      async function startAtend() {
        const pid = val("atend-pac-sel"),
          pr = val("at-prof");
        if (!pid) return showToast("Selecione Paciente", "erro");

        // 1. Inicia atendimento no backend
        await req(
          "/agenda/iniciar_atendimento_paciente",
          "POST",
          { id: pid, prof_id: pr },
          true
        );

        // 2. Carrega dados completos do paciente (para pegar alergias e meds)
        // Precisamos fazer uma busca espec√≠fica ou pegar da lista se j√° tivermos
        const pacientes = await req("/pacientes?filtro="); // Ou crie uma rota /pacientes/<id> que √© melhor
        const paciente = pacientes.find((p) => p.id == pid);

        // Preenche Alertas
        if (paciente) {
          el("atend-pac-name").innerText = "Paciente: " + paciente.nome;
          el("at-alergias").value = paciente.alergias || "";
          el("at-meds-uso").value =
            paciente.medicamentos_em_uso || "Nada consta";
        }

        // Limpa campos vitais e textos
        [
          "at-peso",
          "at-altura",
          "at-pa",
          "at-temp",
          "at-sat",
          "at-evo",
          "at-pres",
          "at-exm",
          "atend-cid",
        ].forEach((i) => (el(i).value = ""));

        el("atend-sel-area").style.display = "none";
        el("atend-main").style.display = "block";
        fill("at-prof", "/profissionais");

        // 3. Carrega Hist√≥rico Visual
        loadHistoricoVisual(pid);
      }
      async function loadHistoricoVisual(pid) {
        const h = await req("/prontuario/" + pid);
        el("at-hist").innerHTML = (h || [])
          .map((i) => {
            const data = i.data_atendimento
              .split(" ")[0]
              .split("-")
              .reverse()
              .join("/");
            return `
          <div style="background:var(--bg-input); padding:10px; border-radius:6px; border-left:4px solid var(--primary); cursor:pointer; transition:0.2s" onclick='verDetalheCompleto(${escapeDados(
            i
          )})'>
              <div style="font-weight:bold; font-size:0.9rem">${data}</div>
              <div style="font-size:0.8rem; color:var(--muted)">${
                i.profissional
              }</div>
              <div style="font-size:0.85rem; margin-top:5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">
                  ${i.evolucao_clinica.substring(0, 50)}...
              </div>
              ${
                i.diagnostico
                  ? `<div style="font-size:0.75rem; color:#F59E0B; margin-top:3px">CID: ${i.diagnostico}</div>`
                  : ""
              }
          </div>
        `;
          })
          .join("");
      }

      function verDetalheCompleto(i) {
        // Cria um HTML rico para o modal de leitura
        const html = `
            <div style="border-bottom:1px solid #555; padding-bottom:10px; margin-bottom:10px">
                <h3 style="color:var(--primary)">Data: ${
                  i.data_atendimento
                }</h3>
                <small>Profissional: ${i.profissional}</small>
            </div>

            <div style="display:flex; gap:15px; background:#222; padding:10px; border-radius:6px; margin-bottom:15px; font-size:0.9rem">
                <span>‚öñ ${i.peso || "--"}kg</span>
                <span>üìè ${i.altura || "--"}m</span>
                <span>‚ù§ ${i.pressao || "--"}mmHg</span>
                <span>üå° ${i.temp || "--"}¬∞C</span>
            </div>

            <h4 style="color:#ccc; margin-top:10px">üìù Evolu√ß√£o</h4>
            <p style="background:#222; padding:10px; border-radius:4px; white-space:pre-wrap">${
              i.evolucao_clinica
            }</p>

            ${
              i.prescricao
                ? `<h4 style="color:#ccc; margin-top:10px">üíä Prescri√ß√£o</h4>
            <p style="background:#222; padding:10px; border-radius:4px; white-space:pre-wrap">${i.prescricao}</p>`
                : ""
            }

            ${
              i.exames_solicitados
                ? `<h4 style="color:#ccc; margin-top:10px">üî¨ Exames</h4>
            <p style="background:#222; padding:10px; border-radius:4px; white-space:pre-wrap">${i.exames_solicitados}</p>`
                : ""
            }
            
            <div style="margin-top:20px; text-align:right">
                <button class="btn btn-s" onclick="copiarTexto('${
                  i.prescricao || ""
                }')">Copiar Receita</button>
            </div>
          `;

        el("conteudo-leitura").innerHTML = html;
        el("m-leitura").style.display = "flex";
      }

      function copiarTexto(t) {
        if (!t) return showToast("Nada para copiar", "erro");
        el("at-pres").value += "\n" + t; // Joga na receita atual
        showToast("Copiado para a receita atual!");
        closeM("m-leitura");
      }
      function verDetalheHist(t) {
        el("conteudo-leitura").innerText = t;
        el("m-leitura").style.display = "flex";
      }
      function closeAtend() {
        el("atend-main").style.display = "none";
        el("atend-sel-area").style.display = "block";
        loadEspera();
      }
      async function saveAtend() {
        if (
          await req("/prontuario/salvar", "POST", {
            paciente_id: val("atend-pac-sel") || val("atend-pac-sel"), // Pega do select ou vari√°vel global se tiver mudado
            profissional_id: val("at-prof"),
            evolucao: val("at-evo"),
            prescricao: val("at-pres"),
            exames: val("at-exm"),
            diagnostico: val("atend-cid"),

            // Novos Campos
            alergias: val("at-alergias"), // Salva alergia se editou
            peso: val("at-peso"),
            altura: val("at-altura"),
            pressao: val("at-pa"),
            temp: val("at-temp"),
            saturacao: val("at-sat"),
          })
        ) {
          showToast("Atendimento e Prontu√°rio Salvos!");
          closeAtend();
        }
      }
      async function rechamar(id) {
        showToast("Reenviando sinal para TV...");
        // Truque: Muda para "Em Espera" e logo em seguida para "Em Atendimento"
        // A TV percebe a mudan√ßa e toca o som de novo.
        await req("/agenda/status", "POST", { id: id, status: "Em Espera" });

        setTimeout(async () => {
          await req("/agenda/status", "POST", {
            id: id,
            status: "Em Atendimento",
          });
          loadEspera();
        }, 500); // Espera meio segundo
      }

      function openTransf(id, prid, dh, pn, pt) {
        el("m-transf").style.display = "flex";
        el("tr-id").value = id;
        el("tr-pac-nome").value = pn;
        el("tr-pac-tel").value = pt;
        fill("tr-prof", "/profissionais").then(() => {
          el("tr-prof").value = prid;
        });
        const p = dh.split(" ");
        el("tr-data").value = p[0];
        el("tr-hora").value = p[1].substring(0, 5);
      }
      async function confTransf() {
        const d = val("tr-data");
        const h = val("tr-hora");
        const pid = val("tr-prof");

        if (!d || !h || !pid)
          return showToast("Preencha data, hora e profissional", "erro");

        const res = await req("/agendamento/transferir", "POST", {
          id: val("tr-id"),
          profissional_id: pid,
          data: d,
          hora: h,
        });

        // Verifica se deu erro (ex: Hor√°rio ocupado)
        if (res && res.erro) {
          alert("‚ùå N√£o foi poss√≠vel reagendar:\n" + res.erro);
          return;
        }

        if (res && res.msg == "Ok") {
          showToast("‚úÖ Reagendado com sucesso!");
          closeM("m-transf");
          loadEspera();
          loadAgenda(); // Atualiza agenda tamb√©m se estiver aberta

          // Envia zap se tiver telefone
          if (val("tr-pac-tel")) {
            const profNome =
              el("tr-prof").options[el("tr-prof").selectedIndex].text;
            const dataFmt = d.split("-").reverse().join("/");
            const msg = `Ol√° *${val(
              "tr-pac-nome"
            )}*, seu atendimento foi reagendado para *${dataFmt}* √†s *${h}* com *${profNome}*.`;

            if (confirm("Abrir WhatsApp para avisar o paciente?")) {
              window.open(
                `https://api.whatsapp.com/send?phone=55${val(
                  "tr-pac-tel"
                ).replace(/\D/g, "")}&text=${encodeURIComponent(msg)}`,
                "_blank"
              );
            }
          }
        }
      }

      function openFim(id) {
        el("m-fim").style.display = "flex";
        el("fim-id").value = id;
      }
      function toggleRetorno() {
        el("fim-area-retorno").style.display = el("fim-retorno").checked
          ? "block"
          : "none";
      }

      async function loadProf() {
        const l = await req("/profissionais");
        el("t-prof").innerHTML = (l || [])
          .map(
            (p) =>
              // CORRE√á√ÉO AQUI:
              `<tr><td>${p.nome}</td><td>${p.crm}</td><td>${
                p.esp_nome
              }</td><td><button class="btn btn-s" onclick='editProf(${escapeDados(
                p
              )})'>‚úé</button></td></tr>`
          )
          .join("");
      }
      function modProf() {
        el("m-prof").style.display = "flex";
        fill("pr-esp", "/auxiliares/especialidades");
        [
          "pr-id",
          "pr-nome",
          "pr-crm",
          "pr-cpf",
          "pr-nasc",
          "pr-email",
          "pr-tel",
          "pr-rua",
          "pr-banco",
          "pr-pix",
          "pr-comissao",
        ].forEach((i) => (el(i).value = ""));
      }
      function editProf(p) {
        modProf(); // Limpa o modal primeiro

        // Preenche os campos b√°sicos
        el("pr-id").value = p.id;
        el("pr-nome").value = p.nome;
        el("pr-crm").value = p.crm;
        el("pr-email").value = p.email || "";
        el("pr-cpf").value = p.cpf || "";
        el("pr-nasc").value = p.data_nascimento || "";
        el("pr-tel").value = p.telefone || "";
        el("pr-valor").value = p.valor_padrao || "";
        el("pr-esp").value = p.especialidade_id || "";
        el("pr-comissao").value = p.comissao || "";
        el("pr-dias").value = p.disponibilidade || ""; // Se for objeto, pode precisar de JSON.stringify

        // Preenche Endere√ßo (que vem como texto JSON do banco)
        try {
          if (p.endereco) {
            const end =
              typeof p.endereco === "string"
                ? JSON.parse(p.endereco)
                : p.endereco;
            el("pr-rua").value = end.rua || "";
            el("pr-bairro").value = end.bairro || "";
            el("pr-cid").value = end.cidade || "";
          }
        } catch (e) {}

        // Preenche Banco
        try {
          if (p.dados_bancarios) {
            const bank =
              typeof p.dados_bancarios === "string"
                ? JSON.parse(p.dados_bancarios)
                : p.dados_bancarios;
            el("pr-banco").value = bank.banco || "";
            el("pr-ag").value = bank.ag || "";
            el("pr-cc").value = bank.cc || "";
            el("pr-pix").value = bank.pix || "";
          }
        } catch (e) {}
      }
      async function saveProf() {
        // Monta o objeto de endere√ßo
        const endereco = {
          rua: val("pr-rua"),
          bairro: val("pr-bairro"),
          cidade: val("pr-cid"),
        };

        // Monta o objeto banc√°rio
        const banco = {
          banco: val("pr-banco"),
          ag: val("pr-ag"),
          cc: val("pr-cc"),
          pix: val("pr-pix"),
        };

        if (
          await req("/profissionais/salvar", "POST", {
            id: val("pr-id"),
            nome: val("pr-nome"),
            crm: val("pr-crm"),
            esp_id: val("pr-esp"),
            email: val("pr-email"),

            // --- CAMPOS QUE FALTAVAM ---
            cpf: val("pr-cpf"),
            nasc: val("pr-nasc"),
            tel: val("pr-tel"),
            valor_padrao: val("pr-valor"), // O valor da consulta
            comissao: val("pr-comissao"),
            dias: val("pr-dias"),
            endereco: endereco,
            banco: banco,
          })
        ) {
          closeM("m-prof");
          loadProf();
          showToast("Profissional Salvo com Sucesso!");
        }
      }
      async function loadAux(t, b) {
        curAux = t;
        if (b) {
          document
            .querySelectorAll("#v-cadastros .tab")
            .forEach((x) => x.classList.remove("active"));
          b.classList.add("active");
        }
        if (t == "convenios") {
          el("aux-simple-ctrl").style.display = "none";
          el("aux-conv-ctrl").style.display = "block";
          const l = await req("/convenios");
          el("t-aux").innerHTML = l
            .map(
              (c) =>
                // CORRE√á√ÉO AQUI:
                `<tr><td>${
                  c.nome
                }</td><td><button class="btn btn-s" onclick='editConv(${escapeDados(
                  c
                )})'>‚úé</button> <button class="btn btn-d" onclick="delConv(${
                  c.id
                })">X</button></td></tr>`
            )
            .join("");
        } else {
          el("aux-simple-ctrl").style.display = "flex";
          el("aux-conv-ctrl").style.display = "none";
          const l = await req("/auxiliares/" + t);
          el("t-aux").innerHTML = l
            .map(
              (i) =>
                `<tr><td>${i.nome}</td><td><button class="btn btn-d" onclick="delAux(${i.id})">X</button></td></tr>`
            )
            .join("");
        }
      }
      function modConv() {
        el("m-conv").style.display = "flex";
        ["cv-id", "cv-nome"].forEach((i) => (el(i).value = ""));
      }
      function editConv(c) {
        modConv();
        el("cv-id").value = c.id;
        el("cv-nome").value = c.nome;
        el("cv-ans").value = c.registro_ans || ""; // Faltava
        el("cv-cnpj").value = c.cnpj || ""; // Faltava
        el("cv-prazo").value = c.prazo_pagamento || ""; // Faltava
        el("cv-email").value = c.email || ""; // Faltava
        el("cv-site").value = c.site || ""; // Faltava
      }
      async function saveConv() {
        if (
          await req("/convenios/salvar", "POST", {
            id: val("cv-id"),
            nome: val("cv-nome"),
            ans: val("cv-ans"), // Faltava
            cnpj: val("cv-cnpj"), // Faltava
            prazo: val("cv-prazo"), // Faltava
            email: val("cv-email"), // Faltava
            site: val("cv-site"), // Faltava
          })
        ) {
          closeM("m-conv");
          loadAux("convenios");
          showToast("Conv√™nio Salvo!");
        }
      }
      async function delConv(id) {
        if (confirm("Apagar?")) {
          await req(`/auxiliares/convenios/deletar/${id}`, "DELETE");
          loadAux("convenios");
        }
      }
      async function salvAux() {
        if (
          await req(`/auxiliares/${curAux}/salvar`, "POST", {
            nome: val("aux-nome"),
          })
        ) {
          el("aux-nome").value = "";
          loadAux(curAux);
        }
      }
      async function delAux(id) {
        if (confirm("Apagar?")) {
          await req(`/auxiliares/${curAux}/deletar/${id}`, "DELETE");
          loadAux(curAux);
        }
      }

      async function loadPac(f) {
        const l = await req("/pacientes?filtro=" + f);
        el("t-pac").innerHTML = (l || [])
          .map(
            (p) =>
              // CORRE√á√ÉO AQUI:
              `<tr><td>${p.nome}</td><td>${p.cpf || "-"}</td><td>${
                p.telefone_principal || "-"
              }</td><td>${
                p.email || "-"
              }</td><td><button class="btn btn-s" onclick='editPac(${escapeDados(
                p
              )})'>‚úé</button></td></tr>`
          )
          .join("");
      }
      function modPac() {
        el("m-pac").style.display = "flex";
        fill("p-conv", "/auxiliares/convenios");
        ["p-id", "p-nome", "p-cpf"].forEach((i) => (el(i).value = ""));
      }
      function editPac(p) {
        modPac();
        el("p-id").value = p.id;
        el("p-nome").value = p.nome;
        el("p-cpf").value = p.cpf || "";
        el("p-rg").value = p.rg || ""; // Faltava
        el("p-nasc").value = p.data_nascimento || ""; // Faltava
        el("p-sexo").value = p.sexo || "M"; // Faltava
        el("p-tel1").value = p.telefone_principal || "";
        el("p-email").value = p.email || ""; // Faltava

        // Tratamento para endere√ßo (pode vir como JSON ou texto simples)
        let end = "";
        try {
          if (p.endereco && p.endereco.includes("{")) {
            const e = JSON.parse(p.endereco);
            end = `${e.rua || ""} ${e.bairro || ""} ${e.cidade || ""}`;
          } else {
            end = p.endereco || "";
          }
        } catch (e) {
          end = p.endereco || "";
        }
        el("p-end").value = end;

        el("p-conv").value = p.convenio_id || "";
        el("p-meds").value = p.medicamentos_em_uso || ""; // Faltava
        el("p-obs").value = p.observacoes_medicas || ""; // Faltava

        el("search-results").style.display = "none";
      }
      async function savePac() {
        if (
          await req("/pacientes/salvar", "POST", {
            id: val("p-id"),
            nome: val("p-nome"),
            cpf: val("p-cpf"),
            rg: val("p-rg"), // Faltava
            nasc: val("p-nasc"), // Faltava
            sexo: val("p-sexo"), // Faltava
            tel: val("p-tel1"),
            email: val("p-email"), // Faltava
            endereco: val("p-end"), // Faltava
            conv: val("p-conv"),
            meds: val("p-meds"), // Faltava
            obs: val("p-obs"), // Faltava
          })
        ) {
          closeM("m-pac");
          loadPac("");
          showToast("Paciente Salvo!");
        }
      }
      async function loadAgenda() {
        const i = val("ag-ini"),
          f = val("ag-fim"),
          p = val("ag-filter-prof");
        const l = await req(`/agenda?inicio=${i}&fim=${f}&prof_id=${p}`);
        el("t-ag").innerHTML = (l || [])
          .map(
            (a) =>
              // CORRE√á√ÉO AQUI:
              `<tr><td>${a.data_hora_inicio.substring(
                8,
                10
              )}/${a.data_hora_inicio.substring(
                5,
                7
              )} <span style="color:var(--primary)">${a.data_hora_inicio.substring(
                11,
                16
              )}</span></td><td>${a.paciente}</td><td>${
                a.profissional
              }</td><td>${
                a.status
              }</td><td style="text-align:right"><button class="btn btn-s" onclick='editAg(${escapeDados(
                a
              )})'>‚úé</button> <button class="btn btn-d" onclick="delAg(${
                a.id
              })">X</button></td></tr>`
          )
          .join("");
        if (agendaTimelineVisible) loadAgendaTimeline();
      }
      function modAg() {
        el("m-ag").style.display = "flex";
        currentAgId = null; // Reseta para modo CRIA√á√ÉO

        // Carrega as listas
        fill("a-pac", "/pacientes");
        fill("a-prof", "/profissionais");
        fill("a-sala", "/auxiliares/salas");

        // --- LIMPEZA COMPLETA (O QUE FALTAVA) ---
        el("a-valor").value = "";
        el("a-dur").value = "30"; // Volta para o padr√£o
        el("a-sala").value = "";
        el("a-hora").value = "";

        // Define a data para hoje ou a data do filtro
        el("a-data").value =
          val("ag-ini") || new Date().toISOString().split("T")[0];
      }
      function editAg(a) {
        modAg(); // Abre o modal e dispara o carregamento das listas (fill)
        currentAgId = a.id;

        // O setTimeout √© necess√°rio para esperar as listas (Selects) carregarem
        setTimeout(() => {
          // 1. Carrega Paciente e Profissional
          el("a-pac").value = a.paciente_id;
          el("a-prof").value = a.profissional_id;

          // 2. Carrega a SALA (Isso √© o que faltava para fixar)
          if (a.sala_id) el("a-sala").value = a.sala_id;

          // 3. Carrega Valor e Dura√ß√£o (Tamb√©m √© importante)
          el("a-valor").value = a.valor || "";
          el("a-dur").value = a.duracao_minutos || 30;
        }, 300); // 300ms para garantir que o dropdown j√° existe

        // 4. Carrega Data e Hora
        const p = a.data_hora_inicio.split(" ");
        el("a-data").value = p[0];
        el("a-hora").value = p[1].substring(0, 5);
      }
      async function delAg(id) {
        if (confirm("Excluir?")) {
          await req("/agenda/deletar/" + id, "DELETE");
          loadAgenda();
          loadDash();
          if (calendar) calendar.refetchEvents();
        }
      }
      async function saveAg() {
        const pid = val("a-pac"),
          prid = val("a-prof"),
          dt = val("a-data"),
          hr = val("a-hora");

        if (!pid || !prid || !dt || !hr)
          return showToast("Preencha tudo", "erro");

        const resp = await req("/agenda/salvar", "POST", {
          id: currentAgId,
          paciente_id: pid,
          profissional_id: prid,
          data: dt,
          hora: hr,
          sala_id: val("a-sala"),
          duracao: val("a-dur"),
          // Adicionando o valor para garantir que salve se o backend suportar
          // (Nota: O backend atual salva valor principalmente no checkout,
          // mas √© bom mandar daqui tamb√©m para atualiza√ß√µes futuras)
          valor: val("a-valor"),
        });

        if (resp && resp.msg === "Ok") {
          closeM("m-ag");
          loadAgenda();
          loadDash();
          if (calendar) calendar.refetchEvents();
          showToast("Salvo");

          if (!currentAgId) {
            // L√≥gica do WhatsApp ao criar novo
            const o = el("a-pac").options[el("a-pac").selectedIndex];
            if (o.dataset.tel && confirm("Enviar Whats de confirma√ß√£o?")) {
              const m = `Ol√° *${
                o.text
              }*, seu agendamento foi confirmado para *${dt
                .split("-")
                .reverse()
                .join("/")}* √†s *${hr}*!`;
              window.open(
                `https://api.whatsapp.com/send?phone=55${o.dataset.tel.replace(
                  /\D/g,
                  ""
                )}&text=${encodeURIComponent(m)}`,
                "_blank"
              );
            }
          }
        } else if (resp && resp.erro) {
          alert("Erro: " + resp.erro);
        }
      }
      async function irParaAtendimento(agId, pacId) {
        // 1. Muda para a aba de atendimento
        nav(
          "atendimento",
          document.querySelector("button[onclick*='atendimento']")
        );

        // 2. Pequeno delay para a lista de pacientes carregar no select
        setTimeout(() => {
          const sel = el("atend-pac-sel");
          if (sel) {
            sel.value = pacId;
            // 3. Dispara a fun√ß√£o que carrega os dados do paciente
            startAtend();
          }
        }, 500);
      }
      function escapeDados(obj) {
        if (!obj) return "{}";
        // Transforma em string e troca aspas simples e duplas por c√≥digos HTML
        return JSON.stringify(obj)
          .replace(/'/g, "&#39;")
          .replace(/"/g, "&quot;");
      }
      const hojeFin = new Date();
      setTimeout(() => {
        if (el("fin-mes")) el("fin-mes").value = hojeFin.getMonth() + 1;
        if (el("fin-ano")) el("fin-ano").value = hojeFin.getFullYear();
      }, 500);

      // --- FUN√á√ÉO 1: TROCAR ABAS ---
      function tabFin(t, b) {
        curFin = t;
        if (b) {
          document
            .querySelectorAll(".tab")
            .forEach((x) => x.classList.remove("active"));
          b.classList.add("active");
        }
        loadFin();
      }

      // --- FUN√á√ÉO 2: CARREGAR DADOS E CALCULAR TOTAIS ---
      async function loadFin() {
        const mes = val("fin-mes");
        const ano = val("fin-ano");

        // Feedback visual
        el("t-fin").innerHTML =
          '<tr><td colspan="7" style="text-align:center; padding:20px">‚è≥ Calculando dados...</td></tr>';

        // Busca dados
        const lista = await req(`/financeiro/${curFin}?mes=${mes}&ano=${ano}`);
        if (!lista) return;

        // --- C√ÅLCULO DE KPIS (TOTAIS) ---
        let pago = 0,
          pendente = 0,
          vencido = 0,
          total = 0;
        const hojeStr = new Date().toISOString().split("T")[0];

        lista.forEach((i) => {
          const valor = parseFloat(i.valor_total || i.valor);

          if (curFin === "caixa") {
            if (i.tipo === "Entrada") total += valor;
            else total -= valor;
            pago += valor;
          } else {
            const valorPago = parseFloat(i.valor_pago || 0);
            if (i.status === "Pago" || i.status === "Recebido") {
              pago += valorPago;
            } else {
              pendente += valor - valorPago;
              if (i.data_vencimento < hojeStr) vencido += valor - valorPago;
            }
            total += valor;
          }
        });

        // --- ATUALIZA CARDS ---
        if (el("fin-total-pago")) {
          if (curFin === "caixa") {
            el("fin-total-pago").innerText = moeda(pago);
            el("fin-total-pago").parentElement.querySelector("h4").innerText =
              "Movimenta√ß√£o";
            el("fin-total-pendente").innerText = "---";
            el("fin-total-vencido").innerText = "---";
            el("fin-total-geral").innerText = moeda(total);
            el("fin-total-geral").style.color =
              total >= 0 ? "#10B981" : "#EF4444";
            el("fin-total-geral").parentElement.querySelector("h4").innerText =
              "Saldo do Per√≠odo";
          } else {
            el("fin-total-pago").innerText = moeda(pago);
            el("fin-total-pago").parentElement.querySelector("h4").innerText =
              curFin === "receber" ? "Recebido" : "Pago";
            el("fin-total-pendente").innerText = moeda(pendente);
            el("fin-total-vencido").innerText = moeda(vencido);
            el("fin-total-geral").innerText = moeda(total);
            el("fin-total-geral").style.color = "#3B82F6";
            el("fin-total-geral").parentElement.querySelector("h4").innerText =
              "Total Previsto";
          }
        }

        // --- GERA TABELA ---
        let cabecalho = "";
        let corpo = "";

        if (curFin == "caixa") {
          cabecalho = `<tr><th>Data</th><th>Tipo</th><th>Descri√ß√£o</th><th>Usu√°rio</th><th style="text-align:right">Valor</th></tr>`;
          corpo = lista
            .map((i) => {
              const corValor = i.tipo === "Entrada" ? "#10B981" : "#EF4444";
              const sinal = i.tipo === "Entrada" ? "+" : "-";
              return `<tr><td>${fmtDataHora(
                i.data_hora
              )}</td><td><span class="status-badge" style="background:${
                i.tipo === "Entrada" ? "#D1FAE5" : "#FEE2E2"
              }; color:${corValor}">${i.tipo}</span></td><td>${
                i.descricao
              }</td><td style="color:var(--muted); font-size:0.8rem">${
                i.usuario || "-"
              }</td><td style="text-align:right; font-weight:bold; color:${corValor}">${sinal} ${moeda(
                i.valor
              )}</td></tr>`;
            })
            .join("");
        } else {
          const labelPessoa = curFin === "receber" ? "Paciente" : "Fornecedor";
          cabecalho = `<tr><th>Vencimento</th><th>${labelPessoa}</th><th>Descri√ß√£o</th><th>Categoria</th><th>Status</th><th style="text-align:right">Valor</th><th>A√ß√£o</th></tr>`;
          corpo = lista
            .map((i) => {
              const isVencido =
                i.status !== "Pago" &&
                i.status !== "Recebido" &&
                i.data_vencimento < hojeStr;
              let corStatus = "#3B82F6";
              if (i.status === "Pago" || i.status === "Recebido")
                corStatus = "#10B981";
              if (isVencido) corStatus = "#EF4444";
              let badgeText = i.status;
              if (isVencido) badgeText = "ATRASADO";
              const styleRow = isVencido
                ? "background:rgba(239, 68, 68, 0.1)"
                : "";

              return `<tr style="${styleRow}"><td style="font-weight:${
                isVencido ? "bold" : "normal"
              }; color:${isVencido ? "#EF4444" : "var(--text)"}">${fmtData(
                i.data_vencimento
              )}</td><td><strong>${
                i.pessoa || i.descricao
              }</strong></td><td style="color:var(--muted)">${
                i.descricao
              }</td><td><span class="status-badge" style="background:var(--bg-input)">${
                i.categoria || "-"
              }</span></td><td><span class="status-badge" style="background:${corStatus}; color:white">${badgeText}</span>${
                i.parcelas > 1
                  ? `<small style="margin-left:5px">(${i.parcela_atual}/${i.parcelas})</small>`
                  : ""
              }</td><td style="text-align:right; font-weight:bold">${moeda(
                i.valor_total
              )}</td><td>${
                i.status != "Pago" && i.status != "Recebido"
                  ? `<button class="btn btn-s" style="color:#10B981; border:1px solid #10B981" onclick="baixa(${i.id},${i.valor_total})" title="Baixar/Pagar">üí≤ Baixar</button>`
                  : `<span style="color:#10B981">‚úî Conclu√≠do</span>`
              }</td></tr>`;
            })
            .join("");
        }

        if (el("t-fin-head")) el("t-fin-head").innerHTML = cabecalho;
        el("t-fin").innerHTML =
          corpo ||
          '<tr><td colspan="7" style="text-align:center; padding:20px; color:var(--muted)">Nenhum lan√ßamento neste per√≠odo.</td></tr>';
      }

      // --- FUN√á√ÉO 3: ABRIR MODAL (Estava escondida antes) ---
      function modFin() {
        el("m-fin").style.display = "flex";
        ["f-desc", "f-val", "f-cat", "f-cc", "f-forn"].forEach((id) => {
          if (el(id)) el(id).value = "";
        });
        el("f-parc").value = "1";
        el("f-venc").value = new Date().toISOString().split("T")[0];
        fill("f-pac", "/pacientes");
        toggleFin();
      }

      // --- FUN√á√ÉO 4: ALTERNAR CAMPOS DO MODAL ---
      function toggleFin() {
        const t = val("f-tipo");
        el("d-pac").style.display = t == "receber" ? "block" : "none";
        el("d-forn").style.display = t == "pagar" ? "block" : "none";
      }
      function baixa(id, v) {
        el("m-baixa").style.display = "flex";
        el("b-id").value = id;
        el("b-val").value = v;
      }

      async function confBaixa() {
        if (
          await req("/financeiro/baixar", "POST", {
            id: val("b-id"),
            valor_pago: val("b-val"),
            tipo: curFin,
          })
        ) {
          closeM("m-baixa");
          loadFin();
          loadDash();
        }
      }
      async function saveFin() {
        const tipo = val("f-tipo");

        // 1. Valida√ß√£o b√°sica
        if (
          !val("f-desc") ||
          !val("f-val") ||
          !val("f-venc") ||
          !val("f-cat")
        ) {
          return showToast(
            "Preencha: Descri√ß√£o, Valor, Vencimento e Categoria",
            "erro"
          );
        }

        // 2. Monta o objeto para enviar
        const payload = {
          tipo: tipo,
          desc: val("f-desc"),
          valor: val("f-val"),
          venc: val("f-venc"),
          cat: val("f-cat"),
          cc: val("f-cc"),
          forma: val("f-forma"),
          parc: val("f-parc") || 1,
          // Se for Receita pega o Paciente, se for Despesa pega o Fornecedor
          paciente_id: tipo === "receber" ? val("f-pac") : null,
          fornecedor: tipo === "pagar" ? val("f-forn") : null,
        };

        // 3. Envia para o Backend
        const res = await req("/financeiro/salvar", "POST", payload);

        if (res && res.msg === "Ok") {
          showToast("‚úÖ Lan√ßamento salvo com sucesso!");
          closeM("m-fin"); // Fecha a janelinha
          loadFin(); // Atualiza a tabela financeira
          loadDash(); // Atualiza os gr√°ficos do dashboard
        } else {
          alert(
            "Erro ao salvar: " +
              (res && res.erro ? res.erro : "Erro desconhecido")
          );
        }
      }

      let relChartInstance = null; // Vari√°vel global para o gr√°fico

      async function gerarRel() {
        const t = val("rel-tipo"),
          i = val("rel-ini"),
          f = val("rel-fim");

        // Feedback visual
        const btn = document.querySelector("button[onclick='gerarRel()']");
        const txtOriginal = btn.innerText;
        btn.innerText = "‚è≥ Gerando...";

        try {
          const dados = await req("/relatorios/gerar", "POST", {
            tipo: t,
            inicio: i,
            fim: f,
          });

          // 1. Configura Impress√£o
          el("print-title").innerText =
            el("rel-tipo").options[el("rel-tipo").selectedIndex].text;
          el("print-period").innerText = `Per√≠odo: ${i
            .split("-")
            .reverse()
            .join("/")} a ${f.split("-").reverse().join("/")}`;

          // 2. Limpa dados anteriores
          el("rel-kpi-area").innerHTML = "";
          el("rel-tab").querySelector("thead").innerHTML = "";
          el("rel-tab").querySelector("tbody").innerHTML = "";

          if (!dados || !dados.lista || dados.lista.length === 0) {
            el("rel-tab").querySelector("tbody").innerHTML =
              "<tr><td colspan='5' style='text-align:center; padding:20px'>Nenhum dado encontrado para o per√≠odo.</td></tr>";
            if (relChartInstance) {
              relChartInstance.destroy();
              relChartInstance = null;
            }
            el("rel-chart-container").style.display = "none";
            return;
          }

          const lista = dados.lista;
          const res = dados.resumo || {};
          let head = "",
            body = "";

          // 3. L√ìGICA ESPEC√çFICA POR TIPO
          if (t === "financeiro") {
            // --- KPIS ---
            renderKPIs([
              { label: "Receitas", val: moeda(res.receita), color: "#10B981" },
              { label: "Despesas", val: moeda(res.despesa), color: "#EF4444" },
              {
                label: "Saldo L√≠quido",
                val: moeda(res.saldo),
                color: res.saldo >= 0 ? "#3B82F6" : "#EF4444",
              },
              {
                label: "Margem",
                val:
                  res.receita > 0
                    ? Math.round((res.saldo / res.receita) * 100) + "%"
                    : "0%",
                color: "#F59E0B",
              },
            ]);

            // --- GR√ÅFICO ---
            renderChart(
              "bar",
              ["Receita", "Despesa"],
              [res.receita, res.despesa],
              ["#10B981", "#EF4444"],
              "Balan√ßo Financeiro"
            );

            // --- TABELA ---
            head = `<tr><th>Data</th><th>Descri√ß√£o</th><th>Categoria</th><th>Tipo</th><th style="text-align:right">Valor</th></tr>`;
            body = lista
              .map(
                (x) => `
                <tr style="border-left: 4px solid ${
                  x.tipo === "Receita" ? "#10B981" : "#EF4444"
                }">
                    <td>${fmtData(x.data)}</td>
                    <td>${x.descricao}</td>
                    <td><span class="status-badge" style="background:var(--bg-input)">${
                      x.categoria
                    }</span></td>
                    <td>${x.tipo}</td>
                    <td style="text-align:right; font-weight:bold; color:${
                      x.tipo === "Receita" ? "#10B981" : "#EF4444"
                    }">${moeda(x.valor)}</td>
                </tr>`
              )
              .join("");
          } else if (t === "agendamentos") {
            // --- KPIS ---
            const ticketMedio =
              res.total_qtd > 0 ? res.total_valor / res.total_qtd : 0;
            renderKPIs([
              {
                label: "Total Agendamentos",
                val: res.total_qtd,
                color: "#3B82F6",
              },
              {
                label: "Valor Estimado",
                val: moeda(res.total_valor),
                color: "#10B981",
              },
              {
                label: "Ticket M√©dio",
                val: moeda(ticketMedio),
                color: "#F59E0B",
              },
            ]);

            // --- GR√ÅFICO ---
            renderChart(
              "doughnut",
              res.labels,
              res.data,
              ["#F59E0B", "#3B82F6", "#10B981", "#EF4444", "#8B5CF6"],
              "Status dos Agendamentos"
            );

            // --- TABELA ---
            head = `<tr><th>Data/Hora</th><th>Paciente</th><th>Profissional</th><th>Status</th><th style="text-align:right">Valor</th></tr>`;
            body = lista
              .map(
                (x) => `
                <tr>
                    <td>${fmtDataHora(x.data_hora_inicio)}</td>
                    <td>${x.paciente}</td>
                    <td>${x.profissional}</td>
                    <td><span class="status-badge st-${x.status
                      .toLowerCase()
                      .replace(" ", "")}">${x.status}</span></td>
                    <td style="text-align:right">${moeda(x.valor)}</td>
                </tr>`
              )
              .join("");
          } else if (t === "profissionais") {
            // --- KPIS ---
            const topProf = lista.length > 0 ? lista[0].profissional : "---";
            renderKPIs([
              { label: "Top Performance", val: topProf, color: "#8B5CF6" },
              {
                label: "Total Atendimentos",
                val: lista.reduce((a, b) => a + b.atendimentos, 0),
                color: "#3B82F6",
              },
            ]);

            // --- GR√ÅFICO ---
            renderChart(
              "bar",
              res.labels,
              res.data_fat,
              "#8B5CF6",
              "Faturamento Estimado por M√©dico (R$)"
            );

            // --- TABELA ---
            head = `<tr><th>Profissional</th><th>Agendados</th><th>Realizados</th><th style="text-align:right">Fat. Estimado</th></tr>`;
            body = lista
              .map(
                (x) => `
                <tr>
                    <td><strong>${x.profissional}</strong></td>
                    <td>${x.atendimentos}</td>
                    <td>${x.finalizados}</td>
                    <td style="text-align:right; color:#10B981">${moeda(
                      x.faturamento_est
                    )}</td>
                </tr>`
              )
              .join("");
          } else if (t === "convenios") {
            // --- GR√ÅFICO ---
            renderChart(
              "pie",
              res.labels,
              res.data,
              ["#3B82F6", "#10B981", "#F59E0B", "#EF4444", "#EC4899"],
              "Distribui√ß√£o por Conv√™nio"
            );

            head = `<tr><th>Conv√™nio</th><th style="text-align:right">Total Atendimentos</th></tr>`;
            body = lista
              .map(
                (x) =>
                  `<tr><td>${x.convenio}</td><td style="text-align:right">${x.atendimentos}</td></tr>`
              )
              .join("");
          } else {
            // Padr√£o (Pacientes, Aniversariantes)
            if (relChartInstance) {
              relChartInstance.destroy();
              relChartInstance = null;
            }
            el("rel-chart-container").style.display = "none";

            head = `<tr>${Object.keys(lista[0])
              .map(
                (k) =>
                  `<th style="text-transform:capitalize">${k.replace(
                    "_",
                    " "
                  )}</th>`
              )
              .join("")}</tr>`;
            body = lista
              .map(
                (r) =>
                  `<tr>${Object.values(r)
                    .map((v) => `<td>${v}</td>`)
                    .join("")}</tr>`
              )
              .join("");
          }

          // Renderiza Tabela
          el("rel-tab").querySelector("thead").innerHTML = head;
          el("rel-tab").querySelector("tbody").innerHTML = body;
        } catch (e) {
          console.error(e);
          showToast("Erro ao gerar relat√≥rio", "erro");
        } finally {
          btn.innerText = txtOriginal;
        }
      }

      // --- FUN√á√ïES AUXILIARES VISUAIS ---

      function renderKPIs(kpis) {
        const area = el("rel-kpi-area");
        area.innerHTML = kpis
          .map(
            (k) => `
        <div class="card" style="padding:15px; text-align:center; border-left:4px solid ${k.color}; margin-bottom:0">
            <h4 style="color:var(--muted); font-size:0.85rem; margin-bottom:5px">${k.label}</h4>
            <h2 style="color:${k.color}; font-size:1.4rem; margin:0">${k.val}</h2>
        </div>
    `
          )
          .join("");
      }

      function renderChart(type, labels, data, colors, title) {
        const ctx = el("rel-chart").getContext("2d");
        el("rel-chart-container").style.display = "block";

        if (relChartInstance) relChartInstance.destroy();

        relChartInstance = new Chart(ctx, {
          type: type,
          data: {
            labels: labels,
            datasets: [
              {
                label: title,
                data: data,
                backgroundColor: colors,
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: "bottom" },
              title: { display: true, text: title, color: "#fff" },
            },
          },
        });
      }

      async function exportarCSV() {
        const t = val("rel-tipo");
        const btn = document.querySelector("button[onclick='exportarCSV()']");
        const originalText = btn.innerText;

        btn.innerText = "‚è≥ Gerando...";
        btn.disabled = true;

        try {
          // 1. Busca os dados do relat√≥rio
          const response = await fetch(`${API}/exportar/${t}`, {
            method: "GET",
            credentials: "include",
          });

          if (response.status === 401) {
            alert("Sess√£o expirada.");
            return;
          }

          const conteudo = await response.text();
          const nomeArquivo = `relatorio_${t}_${
            new Date().toISOString().split("T")[0]
          }.csv`;

          // 2. Tenta usar a janela do Windows (Python)
          if (window.pywebview && window.pywebview.api) {
            // Chama a fun√ß√£o que criamos no passo 1
            const resultado = await window.pywebview.api.salvar_arquivo(
              nomeArquivo,
              conteudo
            );

            if (resultado !== "Cancelado") {
              showToast(resultado); // Mostra notifica√ß√£o verde
            }
          } else {
            // Se cair aqui, √© porque o Python n√£o respondeu, ent√£o baixa direto (Fallback)
            console.warn("PyWebview n√£o detectado, usando download normal.");
            const blob = new Blob([conteudo], {
              type: "text/csv;charset=utf-8;",
            });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = nomeArquivo;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
          }
        } catch (error) {
          console.error(error);
          alert("Erro: " + error.message);
        } finally {
          btn.innerText = originalText;
          btn.disabled = false;
        }
      }
      async function loadUsers() {
        const lista = await req("/usuarios");
        const tbody = el("lista-usuarios");
        if (!lista || lista.erro) {
          tbody.innerHTML =
            "<tr><td colspan='3'>Apenas admin pode ver isso.</td></tr>";
          return;
        }

        tbody.innerHTML = lista
          .map(
            (u) => `
        <tr>
            <td>${u.username}</td>
            <td>${u.role === "admin" ? "üõ°Ô∏è Admin" : "üë§ Usu√°rio"}</td>
            <td>
                ${
                  u.id !== 1
                    ? `<button class="btn btn-d" onclick="delUser(${u.id})">üóëÔ∏è</button>`
                    : ""
                }
            </td>
        </tr>
    `
          )
          .join("");
      }

      async function addUser() {
        const user = val("u-new-user");
        const pass = val("u-new-pass");
        const role = val("u-new-role");

        // Coleta os checkboxes marcados
        const perms = Array.from(
          document.querySelectorAll(".perm-check:checked")
        ).map((el) => el.value);

        if (!user || !pass)
          return showToast("Preencha usu√°rio e senha", "erro");

        const res = await req("/usuarios/salvar", "POST", {
          username: user,
          password: pass,
          role: role,
          perms: perms, // Envia a lista para o banco
        });

        if (res && res.msg) {
          showToast("Usu√°rio criado com sucesso!");
          el("u-new-user").value = "";
          el("u-new-pass").value = "";
          loadUsers();
        } else {
          alert(res.erro || "Erro ao criar");
        }
      }
      function aplicarPermissoes(permissoes, role) {
        // Converte string JSON para array se necess√°rio
        let userPerms = [];
        try {
          userPerms =
            typeof permissoes === "string"
              ? JSON.parse(permissoes)
              : permissoes;
        } catch (e) {
          userPerms = [];
        }

        // Admin v√™ tudo
        if (role === "admin") {
          document
            .querySelectorAll("nav button")
            .forEach((b) => (b.style.display = "flex"));
          // Garante que o dashboard mostre dinheiro se a API retornar
          return;
        }

        // Usu√°rio Comum: Filtra bot√µes da barra lateral
        document.querySelectorAll("nav button").forEach((btn) => {
          const span = btn.querySelector("span");
          if (!span) return;

          const texto = span.innerText.toLowerCase();
          let permitido = false;

          // Telas b√°sicas sempre liberadas
          if (
            texto.includes("dashboard") ||
            texto.includes("espera") ||
            texto.includes("atendimento") ||
            texto.includes("minha conta") ||
            texto.includes("sair")
          ) {
            permitido = true;
          }
          // Telas condicionais (baseadas nos checkboxes)
          else if (
            texto.includes("pacientes") &&
            userPerms.includes("pacientes")
          )
            permitido = true;
          else if (
            texto.includes("profissionais") &&
            userPerms.includes("profissionais")
          )
            permitido = true;
          else if (texto.includes("agenda") && userPerms.includes("agenda"))
            permitido = true;
          else if (
            texto.includes("financeiro") &&
            userPerms.includes("financeiro")
          )
            permitido = true;
          else if (
            texto.includes("relat√≥rios") &&
            userPerms.includes("relatorios")
          )
            permitido = true;

          // Cadastros, Backup, etc normalmente bloqueados para user comum, a menos que adicione checkbox pra isso
          // Aqui vamos manter bloqueado "Cadastros" para users comuns por seguran√ßa padr√£o
          if (texto.includes("cadastros")) permitido = false;

          btn.style.display = permitido ? "flex" : "none";
        });
      }

      async function delUser(id) {
        if (confirm("Remover acesso deste usu√°rio?")) {
          await req("/usuarios/deletar/" + id, "DELETE");
          loadUsers();
        }
      }

      // Formatadores
      const moeda = (v) =>
        parseFloat(v || 0).toLocaleString("pt-BR", {
          style: "currency",
          currency: "BRL",
        });
      const fmtData = (d) => (d ? d.split("-").reverse().join("/") : "-");
      const fmtDataHora = (dh) =>
        dh
          ? dh.substring(8, 10) +
            "/" +
            dh.substring(5, 7) +
            " " +
            dh.substring(11, 16)
          : "-";
      window.onload = checkAuth;
    </script>
  </body>
</html>
